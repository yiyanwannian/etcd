@startuml etcd-architectural-design-principles
!theme plain
title etcd æ¶æ„è®¾è®¡åŸåˆ™ä¸æ¨¡å¼ - åŸºäºæºç åˆ†æ

' ===== åˆ†å±‚æ¶æ„è®¾è®¡ =====
package "åˆ†å±‚æ¶æ„ Layered Architecture" {
  
  ' å®¢æˆ·ç«¯æ¥å…¥å±‚ - å¤šåè®®æ”¯æŒ
  package "æ¥å…¥å±‚ Access Layer" <<Cloud>> {
    interface "gRPC Protocol" as GRPC_PROTO {
      +KV, Watch, Lease, Auth
      +Cluster, Maintenance
      --
      ğŸ“ api/etcdserverpb/rpc.proto
      è®¾è®¡åŸåˆ™: åè®®æ— å…³æ€§
    }
    
    interface "HTTP/REST Protocol" as HTTP_PROTO {
      +RESTful API Gateway
      +JSON â†” Protobuf è½¬æ¢
      --
      ğŸ“ grpc-gateway
      è®¾è®¡åŸåˆ™: å¤šåè®®å…¼å®¹
    }
    
    class "Client SDK" as CLIENT_SDK {
      +ç»Ÿä¸€æ¥å£æŠ½è±¡
      +è¿æ¥æ± ç®¡ç†
      +è´Ÿè½½å‡è¡¡
      +æ•…éšœè½¬ç§»
      --
      ğŸ“ client/v3/client.go
      è®¾è®¡æ¨¡å¼: Facade é—¨é¢æ¨¡å¼
    }
  }
  
  ' API ç½‘å…³å±‚ - è£…é¥°å™¨æ¨¡å¼
  package "ç½‘å…³å±‚ Gateway Layer" <<Rectangle>> {
    abstract class "BaseKVServer" as BASE_KV {
      +Range(), Put(), Delete()
      +Txn(), Compact()
      --
      ğŸ“ server/etcdserver/api/v3rpc/key.go
      è®¾è®¡åŸåˆ™: å•ä¸€èŒè´£
    }
    
    class "QuotaKVServer" as QUOTA_KV {
      -kvServer: KVServer
      +checkQuota()
      +Put(), Txn()
      --
      ğŸ“ server/etcdserver/api/v3rpc/quota.go
      è®¾è®¡æ¨¡å¼: Decorator è£…é¥°å™¨
    }
    
    class "AuthKVServer" as AUTH_KV {
      -kvServer: KVServer
      +checkAuth()
      +Range(), Put(), Delete()
      --
      ğŸ“ server/etcdserver/api/v3rpc/auth.go
      è®¾è®¡æ¨¡å¼: Decorator è£…é¥°å™¨
    }
    
    class "InterceptorChain" as INTERCEPTOR {
      +UnaryInterceptor()
      +StreamInterceptor()
      --
      ğŸ“ server/etcdserver/api/v3rpc/interceptor.go
      è®¾è®¡æ¨¡å¼: Chain of Responsibility
    }
  }
  
  ' æ ¸å¿ƒä¸šåŠ¡å±‚ - ä¾èµ–æ³¨å…¥
  package "ä¸šåŠ¡å±‚ Business Layer" <<Rectangle>> {
    class "EtcdServer" as ETCD_SERVER {
      -kv: mvcc.WatchableKV
      -lessor: lease.Lessor
      -authStore: auth.AuthStore
      -raftNode: *raftNode
      -cluster: *membership.RaftCluster
      +Process(), Apply()
      --
      ğŸ“ server/etcdserver/server.go
      è®¾è®¡æ¨¡å¼: Dependency Injection
      è®¾è®¡åŸåˆ™: æ§åˆ¶åè½¬ IoC
    }
    
    interface "Applier" as APPLIER_INTERFACE {
      +Apply()
      +Put(), Range(), Delete()
      +Txn()
    }
    
    class "UberApplier" as UBER_APPLIER {
      -applyV3: ApplierV3
      +Apply()
      +dispatch()
      --
      ğŸ“ server/etcdserver/apply/uber_applier.go
      è®¾è®¡æ¨¡å¼: Strategy + Template Method
    }
  }
  
  ' ä¸€è‡´æ€§å±‚ - çŠ¶æ€æœºæ¨¡å¼
  package "ä¸€è‡´æ€§å±‚ Consensus Layer" <<Rectangle>> {
    interface "StateMachine" as STATE_MACHINE {
      +Apply()
      +Snapshot()
      +Restore()
    }
    
    class "RaftNode" as RAFT_NODE {
      -node: raft.Node
      -storage: *raft.MemoryStorage
      -transport: rafthttp.Transporter
      +propose(), step()
      --
      ğŸ“ server/etcdserver/raft.go
      è®¾è®¡æ¨¡å¼: State Machine
    }
    
    class "RaftStateMachine" as RAFT_SM {
      +Leader, Follower, Candidate
      +handleAppendEntries()
      +handleRequestVote()
      --
      ğŸ“ raft/raft.go
      è®¾è®¡æ¨¡å¼: State Pattern
    }
  }
  
  ' å­˜å‚¨å±‚ - ç­–ç•¥æ¨¡å¼ä¸è§‚å¯Ÿè€…æ¨¡å¼
  package "å­˜å‚¨å±‚ Storage Layer" <<Database>> {
    interface "KV" as KV_INTERFACE {
      +Read(), Write()
      +Range(), Put(), Delete()
      --
      ğŸ“ server/storage/mvcc/kv.go
      è®¾è®¡åŸåˆ™: æ¥å£éš”ç¦»
    }
    
    class "WatchableStore" as WATCHABLE_STORE {
      -store: *store
      -synced: watcherGroup
      -unsynced: watcherGroup
      +watch(), notify()
      --
      ğŸ“ server/storage/mvcc/watchable_store.go
      è®¾è®¡æ¨¡å¼: Observer è§‚å¯Ÿè€…
    }
    
    class "MVCCStore" as MVCC_STORE {
      -kvindex: index
      -backend: backend.Backend
      +Put(), Range(), Delete()
      --
      ğŸ“ server/storage/mvcc/kvstore.go
      è®¾è®¡æ¨¡å¼: Strategy ç­–ç•¥
    }
    
    interface "Backend" as BACKEND_INTERFACE {
      +ReadTx(), BatchTx()
      +Snapshot(), Hash()
      --
      ğŸ“ server/storage/backend/backend.go
      è®¾è®¡æ¨¡å¼: Strategy ç­–ç•¥
    }
  }
}

' ===== è®¾è®¡æ¨¡å¼å…³ç³» =====
package "è®¾è®¡æ¨¡å¼å®ç° Design Patterns" {
  
  ' è£…é¥°å™¨æ¨¡å¼é“¾
  BASE_KV <|-- QUOTA_KV : è£…é¥°
  QUOTA_KV <|-- AUTH_KV : è£…é¥°
  note right of AUTH_KV
    è£…é¥°å™¨æ¨¡å¼ (Decorator Pattern)
    
    åŠ¨æ€æ·»åŠ åŠŸèƒ½:
    - é…é¢æ£€æŸ¥è£…é¥°å™¨
    - æƒé™éªŒè¯è£…é¥°å™¨
    - æ—¥å¿—è®°å½•è£…é¥°å™¨
    
    ä¼˜åŠ¿:
    - åŠŸèƒ½ç»„åˆçµæ´»
    - å•ä¸€èŒè´£åŸåˆ™
    - å¼€é—­åŸåˆ™
  end note
  
  ' è§‚å¯Ÿè€…æ¨¡å¼
  class "WatcherGroup" as WATCHER_GROUP {
    +add(), delete()
    +choose(), notify()
    --
    ğŸ“ server/storage/mvcc/watcher_group.go
  }
  
  class "Watcher" as WATCHER {
    +send()
    +filter()
    --
    ğŸ“ server/storage/mvcc/watcher.go
  }
  
  WATCHABLE_STORE --> WATCHER_GROUP : ç®¡ç†
  WATCHER_GROUP --> WATCHER : åŒ…å«
  note right of WATCHER
    è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)
    
    äº‹ä»¶é€šçŸ¥æœºåˆ¶:
    - é”®å€¼å˜æ›´äº‹ä»¶
    - å¼‚æ­¥äº‹ä»¶åˆ†å‘
    - è¿‡æ»¤å™¨æ”¯æŒ
    
    ä¼˜åŠ¿:
    - æ¾è€¦åˆè®¾è®¡
    - æ”¯æŒå¹¿æ’­é€šä¿¡
    - åŠ¨æ€è®¢é˜…/å–æ¶ˆ
  end note
  
  ' ç­–ç•¥æ¨¡å¼
  interface "CompactionStrategy" as COMPACT_STRATEGY {
    +Compact()
  }
  
  class "PeriodicCompactor" as PERIODIC_COMPACT {
    +Compact()
    --
    ğŸ“ server/storage/mvcc/compactor/periodic.go
  }
  
  class "RevisionCompactor" as REVISION_COMPACT {
    +Compact()
    --
    ğŸ“ server/storage/mvcc/compactor/revision.go
  }
  
  COMPACT_STRATEGY <|.. PERIODIC_COMPACT
  COMPACT_STRATEGY <|.. REVISION_COMPACT
  note right of COMPACT_STRATEGY
    ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
    
    å‹ç¼©ç­–ç•¥:
    - å®šæœŸå‹ç¼©ç­–ç•¥
    - ç‰ˆæœ¬å‹ç¼©ç­–ç•¥
    
    ä¼˜åŠ¿:
    - ç®—æ³•å¯æ›¿æ¢
    - è¿è¡Œæ—¶åˆ‡æ¢
    - æ˜“äºæ‰©å±•
  end note
}

' ===== æ¶æ„åŸåˆ™ä½“ç° =====
package "æ¶æ„åŸåˆ™ Architectural Principles" {
  
  class "DependencyInversion" as DI_PRINCIPLE {
    é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—
    ä¸¤è€…éƒ½ä¾èµ–äºæŠ½è±¡
    --
    ä½“ç°:
    - EtcdServer ä¾èµ–æ¥å£
    - é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥
    - é…ç½®é©±åŠ¨ç»„è£…
  }
  
  class "SingleResponsibility" as SRP_PRINCIPLE {
    æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ªå˜åŒ–åŸå› 
    --
    ä½“ç°:
    - KV æ“ä½œç‹¬ç«‹
    - Auth è®¤è¯ç‹¬ç«‹
    - Watch ç›‘å¬ç‹¬ç«‹
    - Lease ç§Ÿçº¦ç‹¬ç«‹
  }
  
  class "OpenClosed" as OCP_PRINCIPLE {
    å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
    --
    ä½“ç°:
    - è£…é¥°å™¨æ¨¡å¼æ‰©å±•åŠŸèƒ½
    - æ’ä»¶åŒ–æ¶æ„
    - æ¥å£é©±åŠ¨è®¾è®¡
  }
  
  class "InterfaceSegregation" as ISP_PRINCIPLE {
    å®¢æˆ·ç«¯ä¸åº”ä¾èµ–ä¸éœ€è¦çš„æ¥å£
    --
    ä½“ç°:
    - ReadView / WriteView åˆ†ç¦»
    - ç»†ç²’åº¦æ¥å£è®¾è®¡
    - æŒ‰éœ€å®ç°æ¥å£
  }
}

' ===== æ•°æ®æµä¸æ§åˆ¶æµ =====
package "æ•°æ®æµè®¾è®¡ Data Flow Design" {
  
  ' è¯·æ±‚å¤„ç†æµæ°´çº¿
  CLIENT_SDK --> INTERCEPTOR : 1. è¯·æ±‚æ‹¦æˆª
  INTERCEPTOR --> AUTH_KV : 2. æƒé™æ£€æŸ¥
  AUTH_KV --> QUOTA_KV : 3. é…é¢æ£€æŸ¥
  QUOTA_KV --> BASE_KV : 4. ä¸šåŠ¡å¤„ç†
  BASE_KV --> ETCD_SERVER : 5. æœåŠ¡è°ƒç”¨
  ETCD_SERVER --> RAFT_NODE : 6. ä¸€è‡´æ€§å¤„ç†
  RAFT_NODE --> MVCC_STORE : 7. çŠ¶æ€åº”ç”¨
  MVCC_STORE --> BACKEND_INTERFACE : 8. æŒä¹…åŒ–
  
  ' äº‹ä»¶é€šçŸ¥æµ
  MVCC_STORE --> WATCHABLE_STORE : äº‹ä»¶äº§ç”Ÿ
  WATCHABLE_STORE --> WATCHER_GROUP : äº‹ä»¶åˆ†å‘
  WATCHER_GROUP --> CLIENT_SDK : äº‹ä»¶æ¨é€
  
  note as FLOW_NOTE
    æ•°æ®æµè®¾è®¡åŸåˆ™:
    
    1. å•å‘æ•°æ®æµ
       - è¯·æ±‚ä»ä¸Šåˆ°ä¸‹
       - äº‹ä»¶ä»ä¸‹åˆ°ä¸Š
    
    2. ç®¡é“è¿‡æ»¤å™¨
       - æ‹¦æˆªå™¨é“¾å¤„ç†
       - è£…é¥°å™¨é“¾å¢å¼º
    
    3. å¼‚æ­¥äº‹ä»¶é©±åŠ¨
       - Watch äº‹ä»¶å¼‚æ­¥
       - Raft æ¶ˆæ¯å¼‚æ­¥
    
    4. åˆ†å±‚èŒè´£æ¸…æ™°
       - æ¯å±‚ä¸“æ³¨ç‰¹å®šèŒè´£
       - å±‚é—´é€šè¿‡æ¥å£é€šä¿¡
  end note
}

' ===== å¹¶å‘æ§åˆ¶è®¾è®¡ =====
package "å¹¶å‘æ§åˆ¶ Concurrency Control" {
  
  class "MVCCConcurrency" as MVCC_CONCURRENCY {
    +è¯»å†™åˆ†ç¦»
    +ç‰ˆæœ¬æ§åˆ¶
    +æ— é”è¯»å–
    --
    ğŸ“ server/storage/mvcc/kvstore.go
    è®¾è®¡åŸåˆ™: ä¹è§‚å¹¶å‘æ§åˆ¶
  }
  
  class "RaftConcurrency" as RAFT_CONCURRENCY {
    +Leader ä¸²è¡ŒåŒ–å†™å…¥
    +Follower å¹¶è¡Œè¯»å–
    +æ¶ˆæ¯å¼‚æ­¥å¤„ç†
    --
    ğŸ“ raft/raft.go
    è®¾è®¡åŸåˆ™: ä¸»ä»å¤åˆ¶
  }
  
  class "WatchConcurrency" as WATCH_CONCURRENCY {
    +äº‹ä»¶å¼‚æ­¥åˆ†å‘
    +æ‰¹é‡å¤„ç†ä¼˜åŒ–
    +èƒŒå‹æ§åˆ¶
    --
    ğŸ“ server/storage/mvcc/watchable_store.go
    è®¾è®¡åŸåˆ™: ç”Ÿäº§è€…æ¶ˆè´¹è€…
  }
  
  note as CONCURRENCY_NOTE
    å¹¶å‘æ§åˆ¶ç­–ç•¥:
    
    1. è¯»å†™åˆ†ç¦»
       - MVCC æ”¯æŒå¹¶å‘è¯»
       - Raft ä¿è¯å†™ä¸€è‡´æ€§
    
    2. æ— é”è®¾è®¡
       - ç‰ˆæœ¬å·ä¹è§‚æ§åˆ¶
       - CAS åŸå­æ“ä½œ
    
    3. å¼‚æ­¥å¤„ç†
       - äº‹ä»¶å¼‚æ­¥åˆ†å‘
       - æ¶ˆæ¯å¼‚æ­¥ä¼ è¾“
    
    4. èƒŒå‹æ§åˆ¶
       - æ…¢æ¶ˆè´¹è€…å¤„ç†
       - æµé‡æ§åˆ¶æœºåˆ¶
  end note
}

@enduml
