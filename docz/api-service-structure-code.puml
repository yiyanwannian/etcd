@startuml api-service-structure-code
!theme plain
title etcd API æœåŠ¡ç»“æ„å›¾ - ä»£ç å®ç°ä½ç½®

package "gRPC æœåŠ¡å®šä¹‰ gRPC Services" {
  interface KVServer {
    +Range(): (*RangeResponse, error)
    +Put(): (*PutResponse, error)
    +DeleteRange(): (*DeleteRangeResponse, error)
    +Txn(): (*TxnResponse, error)
    +Compact(): (*CompactionResponse, error)
    --
    ğŸ“ api/etcdserverpb/rpc.proto:KV
    ğŸ“ server/etcdserver/api/v3rpc/key.go:kvServer
    ğŸ“ server/etcdserver/api/v3rpc/key.go:(*kvServer).Range()
    ğŸ“ server/etcdserver/api/v3rpc/key.go:(*kvServer).Put()
    ğŸ“ server/etcdserver/api/v3rpc/key.go:(*kvServer).Txn()
  }
  
  interface WatchServer {
    +Watch(): (Watch_WatchServer, error)
    --
    ğŸ“ api/etcdserverpb/rpc.proto:Watch
    ğŸ“ server/etcdserver/api/v3rpc/watch.go:watchServer
    ğŸ“ server/etcdserver/api/v3rpc/watch.go:(*watchServer).Watch()
  }
  
  interface LeaseServer {
    +LeaseGrant(): (*LeaseGrantResponse, error)
    +LeaseRevoke(): (*LeaseRevokeResponse, error)
    +LeaseKeepAlive(): (Lease_LeaseKeepAliveServer, error)
    +LeaseTimeToLive(): (*LeaseTimeToLiveResponse, error)
    +LeaseLeases(): (*LeaseLeasesResponse, error)
    --
    ğŸ“ api/etcdserverpb/rpc.proto:Lease
    ğŸ“ server/etcdserver/api/v3rpc/lease.go:LeaseServer
    ğŸ“ server/etcdserver/api/v3rpc/lease.go:(*LeaseServer).LeaseGrant()
    ğŸ“ server/etcdserver/api/v3rpc/lease.go:(*LeaseServer).LeaseKeepAlive()
  }
  
  interface AuthServer {
    +AuthEnable(): (*AuthEnableResponse, error)
    +AuthDisable(): (*AuthDisableResponse, error)
    +Authenticate(): (*AuthenticateResponse, error)
    +UserAdd(): (*AuthUserAddResponse, error)
    +UserGet(): (*AuthUserGetResponse, error)
    +UserList(): (*AuthUserListResponse, error)
    +UserDelete(): (*AuthUserDeleteResponse, error)
    +UserChangePassword(): (*AuthUserChangePasswordResponse, error)
    +UserGrantRole(): (*AuthUserGrantRoleResponse, error)
    +UserRevokeRole(): (*AuthUserRevokeRoleResponse, error)
    +RoleAdd(): (*AuthRoleAddResponse, error)
    +RoleGet(): (*AuthRoleGetResponse, error)
    +RoleList(): (*AuthRoleListResponse, error)
    +RoleDelete(): (*AuthRoleDeleteResponse, error)
    +RoleGrantPermission(): (*AuthRoleGrantPermissionResponse, error)
    +RoleRevokePermission(): (*AuthRoleRevokePermissionResponse, error)
    --
    ğŸ“ api/etcdserverpb/rpc.proto:Auth
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:AuthServer
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*AuthServer).Authenticate()
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*AuthServer).UserAdd()
  }
  
  interface ClusterServer {
    +MemberAdd(): (*MemberAddResponse, error)
    +MemberRemove(): (*MemberRemoveResponse, error)
    +MemberUpdate(): (*MemberUpdateResponse, error)
    +MemberList(): (*MemberListResponse, error)
    +MemberPromote(): (*MemberPromoteResponse, error)
    --
    ğŸ“ api/etcdserverpb/rpc.proto:Cluster
    ğŸ“ server/etcdserver/api/v3rpc/cluster.go:ClusterServer
    ğŸ“ server/etcdserver/api/v3rpc/cluster.go:(*ClusterServer).MemberAdd()
    ğŸ“ server/etcdserver/api/v3rpc/cluster.go:(*ClusterServer).MemberList()
  }
  
  interface MaintenanceServer {
    +Alarm(): (*AlarmResponse, error)
    +Status(): (*StatusResponse, error)
    +Defragment(): (*DefragmentResponse, error)
    +Hash(): (*HashResponse, error)
    +HashKV(): (*HashKVResponse, error)
    +Snapshot(): (Maintenance_SnapshotServer, error)
    +MoveLeader(): (*MoveLeaderResponse, error)
    --
    ğŸ“ api/etcdserverpb/rpc.proto:Maintenance
    ğŸ“ server/etcdserver/api/v3rpc/maintenance.go:MaintenanceServer
    ğŸ“ server/etcdserver/api/v3rpc/maintenance.go:(*MaintenanceServer).Status()
    ğŸ“ server/etcdserver/api/v3rpc/maintenance.go:(*MaintenanceServer).Snapshot()
  }
}

package "æœåŠ¡å®ç° Service Implementation" {
  class kvServer {
    +hdr: header
    +kv: etcdserver.RaftKV
    +lessor: lease.Lessor
    +maxTxnOps: uint
    --
    ğŸ“ server/etcdserver/api/v3rpc/key.go:kvServer
    ğŸ“ server/etcdserver/api/v3rpc/key.go:(*kvServer).Range()
    ğŸ“ server/etcdserver/api/v3rpc/key.go:(*kvServer).Put()
    ğŸ“ server/etcdserver/api/v3rpc/key.go:(*kvServer).DeleteRange()
    ğŸ“ server/etcdserver/api/v3rpc/key.go:(*kvServer).Txn()
    ğŸ“ server/etcdserver/api/v3rpc/key.go:(*kvServer).Compact()
  }
  
  class watchServer {
    +lg: *zap.Logger
    +clusterID: types.ID
    +memberID: types.ID
    +maxRequestBytes: int
    +sg: etcdserver.RaftStatusGetter
    +watchable: mvcc.WatchableKV
    +ag: AuthGetter
    --
    ğŸ“ server/etcdserver/api/v3rpc/watch.go:watchServer
    ğŸ“ server/etcdserver/api/v3rpc/watch.go:(*watchServer).Watch()
    ğŸ“ server/etcdserver/api/v3rpc/watch.go:(*watchServer).recvLoop()
    ğŸ“ server/etcdserver/api/v3rpc/watch.go:(*watchServer).sendLoop()
  }
  
  class leaseServer {
    +hdr: header
    +le: etcdserver.Lessor
    +lg: *zap.Logger
    --
    ğŸ“ server/etcdserver/api/v3rpc/lease.go:LeaseServer
    ğŸ“ server/etcdserver/api/v3rpc/lease.go:(*LeaseServer).LeaseGrant()
    ğŸ“ server/etcdserver/api/v3rpc/lease.go:(*LeaseServer).LeaseRevoke()
    ğŸ“ server/etcdserver/api/v3rpc/lease.go:(*LeaseServer).LeaseKeepAlive()
    ğŸ“ server/etcdserver/api/v3rpc/lease.go:(*LeaseServer).LeaseTimeToLive()
  }
  
  class authServer {
    +hdr: header
    +as: etcdserver.AuthServer
    +lg: *zap.Logger
    --
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:AuthServer
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*AuthServer).AuthEnable()
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*AuthServer).Authenticate()
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*AuthServer).UserAdd()
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*AuthServer).RoleAdd()
  }
  
  class clusterServer {
    +hdr: header
    +cluster: etcdserver.Cluster
    +lg: *zap.Logger
    --
    ğŸ“ server/etcdserver/api/v3rpc/cluster.go:ClusterServer
    ğŸ“ server/etcdserver/api/v3rpc/cluster.go:(*ClusterServer).MemberAdd()
    ğŸ“ server/etcdserver/api/v3rpc/cluster.go:(*ClusterServer).MemberRemove()
    ğŸ“ server/etcdserver/api/v3rpc/cluster.go:(*ClusterServer).MemberList()
  }
  
  class maintenanceServer {
    +lg: *zap.Logger
    +rg: etcdserver.RaftStatusGetter
    +hasher: mvcc.HashStorage
    +bg: etcdserver.BackendGetter
    +a: auth.AuthStore
    --
    ğŸ“ server/etcdserver/api/v3rpc/maintenance.go:MaintenanceServer
    ğŸ“ server/etcdserver/api/v3rpc/maintenance.go:(*MaintenanceServer).Alarm()
    ğŸ“ server/etcdserver/api/v3rpc/maintenance.go:(*MaintenanceServer).Status()
    ğŸ“ server/etcdserver/api/v3rpc/maintenance.go:(*MaintenanceServer).Defragment()
    ğŸ“ server/etcdserver/api/v3rpc/maintenance.go:(*MaintenanceServer).Snapshot()
  }
}

package "è£…é¥°å™¨æ¨¡å¼ Decorator Pattern" {
  class quotaKVServer {
    +KVServer
    +qa: quotaAlarmer
    --
    ğŸ“ server/etcdserver/api/v3rpc/quota.go:quotaKVServer
    ğŸ“ server/etcdserver/api/v3rpc/quota.go:(*quotaKVServer).Put()
    ğŸ“ server/etcdserver/api/v3rpc/quota.go:(*quotaKVServer).Txn()
    ğŸ“ server/etcdserver/api/v3rpc/quota.go:(*quotaKVServer).checkQuota()
  }
  
  class authKVServer {
    +KVServer
    +as: etcdserver.AuthServer
    --
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:authKVServer
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*authKVServer).Range()
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*authKVServer).Put()
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*authKVServer).DeleteRange()
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*authKVServer).checkAuth()
  }
  
  class quotaLeaseServer {
    +LeaseServer
    +qa: quotaAlarmer
    --
    ğŸ“ server/etcdserver/api/v3rpc/quota.go:quotaLeaseServer
    ğŸ“ server/etcdserver/api/v3rpc/quota.go:(*quotaLeaseServer).LeaseGrant()
  }
  
  class authLeaseServer {
    +LeaseServer
    +as: etcdserver.AuthServer
    --
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:authLeaseServer
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*authLeaseServer).LeaseGrant()
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*authLeaseServer).LeaseRevoke()
  }
}

package "HTTP ç½‘å…³ HTTP Gateway" {
  class grpcGateway {
    +mux: *runtime.ServeMux
    +conn: *grpc.ClientConn
    +RegisterKVHandler()
    +RegisterWatchHandler()
    +RegisterLeaseHandler()
    +RegisterAuthHandler()
    +RegisterClusterHandler()
    +RegisterMaintenanceHandler()
    --
    ğŸ“ server/etcdserver/api/v3rpc/grpc.go:Server()
    ğŸ“ api/etcdserverpb/rpc.pb.gw.go:RegisterKVHandlerFromEndpoint()
    ğŸ“ api/etcdserverpb/rpc.pb.gw.go:RegisterWatchHandlerFromEndpoint()
    ğŸ“ api/etcdserverpb/rpc.pb.gw.go:RegisterLeaseHandlerFromEndpoint()
    ğŸ“ github.com/grpc-ecosystem/grpc-gateway/v2/runtime
  }
}

package "æ¶ˆæ¯ç±»å‹ Message Types" {
  class RangeRequest {
    +key: []byte
    +range_end: []byte
    +limit: int64
    +revision: int64
    +sort_order: SortOrder
    +sort_target: SortTarget
    +serializable: bool
    +keys_only: bool
    +count_only: bool
    +min_mod_revision: int64
    +max_mod_revision: int64
    +min_create_revision: int64
    +max_create_revision: int64
    --
    ğŸ“ api/etcdserverpb/rpc.proto:RangeRequest
  }
  
  class PutRequest {
    +key: []byte
    +value: []byte
    +lease: int64
    +prev_kv: bool
    +ignore_value: bool
    +ignore_lease: bool
    --
    ğŸ“ api/etcdserverpb/rpc.proto:PutRequest
  }
  
  class TxnRequest {
    +compare: []Compare
    +success: []RequestOp
    +failure: []RequestOp
    --
    ğŸ“ api/etcdserverpb/rpc.proto:TxnRequest
  }
  
  class WatchRequest {
    +create_request: WatchCreateRequest
    +cancel_request: WatchCancelRequest
    +progress_request: WatchProgressRequest
    --
    ğŸ“ api/etcdserverpb/rpc.proto:WatchRequest
  }
  
  class LeaseGrantRequest {
    +TTL: int64
    +ID: int64
    --
    ğŸ“ api/etcdserverpb/rpc.proto:LeaseGrantRequest
  }
}

package "å“åº”å¤´ Response Header" {
  class ResponseHeader {
    +cluster_id: uint64
    +member_id: uint64
    +revision: int64
    +raft_term: uint64
    --
    ğŸ“ api/etcdserverpb/rpc.proto:ResponseHeader
  }
  
  class header {
    +clusterID: types.ID
    +memberID: types.ID
    +sg: etcdserver.RaftStatusGetter
    +rev: func() int64
    +fill()
    --
    ğŸ“ server/etcdserver/api/v3rpc/header.go:header
    ğŸ“ server/etcdserver/api/v3rpc/header.go:(*header).fill()
  }
}

' å…³ç³»è¿æ¥
kvServer --> KVServer : å®ç°\nğŸ“ v3rpc/key.go
watchServer --> WatchServer : å®ç°\nğŸ“ v3rpc/watch.go
leaseServer --> LeaseServer : å®ç°\nğŸ“ v3rpc/lease.go
authServer --> AuthServer : å®ç°\nğŸ“ v3rpc/auth.go
clusterServer --> ClusterServer : å®ç°\nğŸ“ v3rpc/cluster.go
maintenanceServer --> MaintenanceServer : å®ç°\nğŸ“ v3rpc/maintenance.go

quotaKVServer --> KVServer : è£…é¥°\nğŸ“ v3rpc/quota.go
authKVServer --> KVServer : è£…é¥°\nğŸ“ v3rpc/auth.go
quotaLeaseServer --> LeaseServer : è£…é¥°\nğŸ“ v3rpc/quota.go
authLeaseServer --> LeaseServer : è£…é¥°\nğŸ“ v3rpc/auth.go

quotaKVServer --> kvServer : åŒ…è£…\nğŸ“ v3rpc/quota.go
authKVServer --> quotaKVServer : åŒ…è£…\nğŸ“ v3rpc/auth.go

grpcGateway --> KVServer : HTTP è½¬æ¢\nğŸ“ rpc.pb.gw.go
grpcGateway --> WatchServer : HTTP è½¬æ¢\nğŸ“ rpc.pb.gw.go
grpcGateway --> LeaseServer : HTTP è½¬æ¢\nğŸ“ rpc.pb.gw.go
grpcGateway --> AuthServer : HTTP è½¬æ¢\nğŸ“ rpc.pb.gw.go
grpcGateway --> ClusterServer : HTTP è½¬æ¢\nğŸ“ rpc.pb.gw.go
grpcGateway --> MaintenanceServer : HTTP è½¬æ¢\nğŸ“ rpc.pb.gw.go

kvServer --> header : ä½¿ç”¨å“åº”å¤´\nğŸ“ v3rpc/header.go
leaseServer --> header : ä½¿ç”¨å“åº”å¤´\nğŸ“ v3rpc/header.go
authServer --> header : ä½¿ç”¨å“åº”å¤´\nğŸ“ v3rpc/header.go
clusterServer --> header : ä½¿ç”¨å“åº”å¤´\nğŸ“ v3rpc/header.go

header --> ResponseHeader : ç”Ÿæˆ\nğŸ“ api/etcdserverpb/rpc.proto

note right of kvServer
  KV æœåŠ¡å®ç°ä½ç½®:
  ğŸ“ server/etcdserver/api/v3rpc/key.go
  
  æ ¸å¿ƒæ–¹æ³•:
  - Range(): èŒƒå›´æŸ¥è¯¢
  - Put(): å­˜å‚¨é”®å€¼
  - DeleteRange(): åˆ é™¤èŒƒå›´
  - Txn(): äº‹åŠ¡å¤„ç†
  - Compact(): å‹ç¼©æ“ä½œ
  
  ä¾èµ–ç»„ä»¶:
  - etcdserver.RaftKV: Raft KV æ¥å£
  - lease.Lessor: ç§Ÿçº¦ç®¡ç†å™¨
  - header: å“åº”å¤´ç”Ÿæˆå™¨
end note

note right of watchServer
  Watch æœåŠ¡å®ç°ä½ç½®:
  ğŸ“ server/etcdserver/api/v3rpc/watch.go
  
  æ ¸å¿ƒæ–¹æ³•:
  - Watch(): åˆ›å»ºç›‘å¬æµ
  - recvLoop(): æ¥æ”¶å¾ªç¯
  - sendLoop(): å‘é€å¾ªç¯
  
  æµç®¡ç†:
  - serverWatchStream: æœåŠ¡ç«¯æµ
  - watchStream: ç›‘å¬æµ
  - æ”¯æŒå¤šè·¯å¤ç”¨
  - äº‹ä»¶è¿‡æ»¤å’Œåˆ†å‘
end note

note right of quotaKVServer
  é…é¢è£…é¥°å™¨å®ç°ä½ç½®:
  ğŸ“ server/etcdserver/api/v3rpc/quota.go
  
  åŠŸèƒ½:
  - checkQuota(): æ£€æŸ¥å­˜å‚¨é…é¢
  - æ‹¦æˆª Put å’Œ Txn æ“ä½œ
  - é˜²æ­¢å­˜å‚¨ç©ºé—´è€—å°½
  - ç”Ÿæˆé…é¢å‘Šè­¦
  
  é…é¢ç±»å‹:
  - åç«¯å­˜å‚¨é…é¢
  - è¯·æ±‚å¤§å°é™åˆ¶
end note

note right of authKVServer
  è®¤è¯è£…é¥°å™¨å®ç°ä½ç½®:
  ğŸ“ server/etcdserver/api/v3rpc/auth.go
  
  åŠŸèƒ½:
  - checkAuth(): æƒé™æ£€æŸ¥
  - æ‹¦æˆªæ‰€æœ‰ KV æ“ä½œ
  - éªŒè¯ç”¨æˆ·æƒé™
  - èŒƒå›´æƒé™æ£€æŸ¥
  
  æƒé™ç±»å‹:
  - è¯»æƒé™æ£€æŸ¥
  - å†™æƒé™æ£€æŸ¥
  - ç®¡ç†å‘˜æƒé™æ£€æŸ¥
end note

note right of grpcGateway
  HTTP ç½‘å…³å®ç°ä½ç½®:
  ğŸ“ server/etcdserver/api/v3rpc/grpc.go
  ğŸ“ api/etcdserverpb/rpc.pb.gw.go
  
  ä¾èµ–åº“:
  ğŸ“ github.com/grpc-ecosystem/grpc-gateway/v2
  
  åŠŸèƒ½:
  - gRPC åˆ° HTTP è½¬æ¢
  - RESTful API æ”¯æŒ
  - JSON åºåˆ—åŒ–
  - è·¨åŸŸæ”¯æŒ
  - è‡ªåŠ¨ç”Ÿæˆçš„ç½‘å…³ä»£ç 
end note

note as N1
  gRPC æœåŠ¡å™¨åˆ›å»ºæµç¨‹:
  
  1. server/etcdserver/api/v3rpc/grpc.go:Server()
     â†“
  2. åˆ›å»ºå„ä¸ªæœåŠ¡å®ä¾‹:
     - NewKVServer()
     - NewWatchServer()
     - NewLeaseServer()
     - NewAuthServer()
     - NewClusterServer()
     - NewMaintenanceServer()
     â†“
  3. åº”ç”¨è£…é¥°å™¨:
     - NewQuotaKVServer()
     - NewAuthKVServer()
     â†“
  4. æ³¨å†Œåˆ° gRPC æœåŠ¡å™¨:
     - pb.RegisterKVServer()
     - pb.RegisterWatchServer()
     - pb.RegisterLeaseServer()
     - pb.RegisterAuthServer()
     - pb.RegisterClusterServer()
     - pb.RegisterMaintenanceServer()
  
  æ‹¦æˆªå™¨:
  ğŸ“ server/etcdserver/api/v3rpc/interceptor.go
  - unaryInterceptor(): ä¸€å…ƒ RPC æ‹¦æˆªå™¨
  - streamInterceptor(): æµå¼ RPC æ‹¦æˆªå™¨
end note

@enduml
