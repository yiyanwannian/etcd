@startuml etcd-overall-architecture-code
!theme plain
title etcd æ•´ä½“æ¶æ„å›¾ - ä»£ç å®ç°ä½ç½®

package "å®¢æˆ·ç«¯å±‚ Client Layer" {
  [etcdctl å‘½ä»¤è¡Œå·¥å…·] as CLI
  note right of CLI
    ğŸ“ etcdctl/ctlv3/
    ğŸ“ etcdctl/ctlv3/command/
    ğŸ“ etcdctl/main.go
    
    ä¸»è¦åŠŸèƒ½:
    - å‘½ä»¤è§£æå’Œæ‰§è¡Œ
    - å®¢æˆ·ç«¯ SDK å°è£…
    - è¾“å‡ºæ ¼å¼åŒ–
  end note
  
  [Client SDK] as SDK
  note right of SDK
    ğŸ“ client/v3/client.go
    ğŸ“ client/v3/kv.go
    ğŸ“ client/v3/watch.go
    ğŸ“ client/v3/lease.go
    ğŸ“ client/v3/auth.go
    
    æ ¸å¿ƒæ¥å£:
    - KV, Watcher, Lease
    - Auth, Cluster, Maintenance
  end note
  
  [HTTP å®¢æˆ·ç«¯] as HTTP
  note right of HTTP
    ğŸ“ client/v2/client.go
    ğŸ“ client/v2/http.go
    
    HTTP API å®¢æˆ·ç«¯:
    - RESTful æ¥å£å°è£…
    - JSON åºåˆ—åŒ–
  end note
}

package "API ç½‘å…³å±‚ API Gateway" {
  [gRPC æœåŠ¡å™¨] as GRPC
  note right of GRPC
    ğŸ“ server/etcdserver/api/v3rpc/
    ğŸ“ server/etcdserver/api/v3rpc/grpc.go
    ğŸ“ server/etcdserver/api/v3rpc/interceptor.go
    
    æœåŠ¡å®ç°:
    - KVServer, WatchServer
    - LeaseServer, AuthServer
    - ClusterServer, MaintenanceServer
  end note
  
  [REST ç½‘å…³] as REST
  note right of REST
    ğŸ“ server/etcdserver/api/v3rpc/grpc.go
    ğŸ“ github.com/grpc-ecosystem/grpc-gateway
    
    HTTP åˆ° gRPC è½¬æ¢:
    - REST API ç«¯ç‚¹æ˜ å°„
    - JSON ä¸ Protobuf è½¬æ¢
  end note
  
  [è®¤è¯æ¨¡å—] as AUTH
  note right of AUTH
    ğŸ“ server/auth/store.go
    ğŸ“ server/auth/jwt.go
    ğŸ“ server/auth/simple_token.go
    
    è®¤è¯åŠŸèƒ½:
    - ç”¨æˆ·å’Œè§’è‰²ç®¡ç†
    - ä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯
    - æƒé™æ£€æŸ¥
  end note
}

package "æ ¸å¿ƒæœåŠ¡å±‚ Core Service" {
  [EtcdServer ä¸»æœåŠ¡] as ETCD
  note right of ETCD
    ğŸ“ server/etcdserver/server.go
    ğŸ“ server/etcdserver/raft.go
    ğŸ“ server/etcdserver/apply/
    
    æ ¸å¿ƒåŠŸèƒ½:
    - è¯·æ±‚å¤„ç†å’Œè·¯ç”±
    - Raft é›†æˆç®¡ç†
    - çŠ¶æ€æœºåº”ç”¨
  end note
  
  [Raft ä¸€è‡´æ€§å¼•æ“] as RAFT
  note right of RAFT
    ğŸ“ raft/raft.go
    ğŸ“ raft/node.go
    ğŸ“ raft/rawnode.go
    ğŸ“ raft/log.go
    
    Raft å®ç°:
    - é¢†å¯¼è€…é€‰ä¸¾
    - æ—¥å¿—å¤åˆ¶
    - çŠ¶æ€æœºæ¥å£
  end note
  
  [Apply åº”ç”¨æ¨¡å—] as APPLY
  note right of APPLY
    ğŸ“ server/etcdserver/apply/apply.go
    ğŸ“ server/etcdserver/apply/apply_v3.go
    
    çŠ¶æ€æœºåº”ç”¨:
    - Raft æ—¥å¿—åº”ç”¨
    - MVCC æ“ä½œæ‰§è¡Œ
    - å“åº”ç”Ÿæˆ
  end note
  
  [é›†ç¾¤ç®¡ç†å™¨] as CLUSTER
  note right of CLUSTER
    ğŸ“ server/etcdserver/api/membership/
    ğŸ“ server/etcdserver/api/membership/cluster.go
    
    é›†ç¾¤ç®¡ç†:
    - æˆå‘˜æ·»åŠ /åˆ é™¤
    - é…ç½®å˜æ›´
    - å¥åº·æ£€æŸ¥
  end note
}

package "å­˜å‚¨å±‚ Storage Layer" {
  [MVCC å¼•æ“] as MVCC
  note right of MVCC
    ğŸ“ server/storage/mvcc/kvstore.go
    ğŸ“ server/storage/mvcc/kvstore_txn.go
    ğŸ“ server/storage/mvcc/watchable_store.go
    ğŸ“ server/storage/mvcc/index.go
    
    MVCC åŠŸèƒ½:
    - å¤šç‰ˆæœ¬å­˜å‚¨
    - äº‹åŠ¡å¤„ç†
    - ç´¢å¼•ç®¡ç†
    - Watch æœºåˆ¶
  end note
  
  [Backend åç«¯å­˜å‚¨] as BACKEND
  note right of BACKEND
    ğŸ“ server/storage/backend/backend.go
    ğŸ“ server/storage/backend/batch_tx.go
    ğŸ“ github.com/etcd-io/bbolt
    
    åç«¯å­˜å‚¨:
    - BoltDB å°è£…
    - æ‰¹é‡äº‹åŠ¡
    - æ•°æ®æŒä¹…åŒ–
  end note
  
  [WAL é¢„å†™æ—¥å¿—] as WAL
  note right of WAL
    ğŸ“ server/storage/wal/wal.go
    ğŸ“ server/storage/wal/encoder.go
    ğŸ“ server/storage/wal/decoder.go
    
    WAL åŠŸèƒ½:
    - æ—¥å¿—å†™å…¥å’Œè¯»å–
    - æ•°æ®æ¢å¤
    - æ ¡éªŒå’ŒéªŒè¯
  end note
  
  [Snapshot å¿«ç…§] as SNAP
  note right of SNAP
    ğŸ“ server/storage/snap/snapshotter.go
    ğŸ“ server/storage/snap/db.go
    
    å¿«ç…§ç®¡ç†:
    - å¿«ç…§åˆ›å»ºå’ŒåŠ è½½
    - æ•°æ®å‹ç¼©
    - å¢é‡å¤‡ä»½
  end note
}

package "åŸºç¡€è®¾æ–½å±‚ Infrastructure" {
  [Lease ç§Ÿçº¦ç®¡ç†] as LEASE
  note right of LEASE
    ğŸ“ server/lease/lessor.go
    ğŸ“ server/lease/lease_queue.go
    ğŸ“ server/lease/lease.go
    
    ç§Ÿçº¦åŠŸèƒ½:
    - ç”Ÿå‘½å‘¨æœŸç®¡ç†
    - è¿‡æœŸæ£€æµ‹
    - é”®å€¼å…³è”
  end note
  
  [Watch ç›‘å¬ç³»ç»Ÿ] as WATCH
  note right of WATCH
    ğŸ“ server/storage/mvcc/watcher.go
    ğŸ“ server/storage/mvcc/watchable_store.go
    ğŸ“ server/etcdserver/api/v3rpc/watch.go
    
    Watch åŠŸèƒ½:
    - äº‹ä»¶ç›‘å¬
    - æµå¼æ¨é€
    - è¿‡æ»¤æœºåˆ¶
  end note
  
  [Auth æƒé™ç³»ç»Ÿ] as AUTHSYS
  note right of AUTHSYS
    ğŸ“ server/auth/store.go
    ğŸ“ server/auth/range_perm_cache.go
    ğŸ“ server/etcdserver/api/v3rpc/auth.go
    
    æƒé™ç³»ç»Ÿ:
    - RBAC æ¨¡å‹
    - æƒé™ç¼“å­˜
    - è®¿é—®æ§åˆ¶
  end note
}

' å®¢æˆ·ç«¯åˆ°APIå±‚çš„è¿æ¥
CLI --> GRPC : gRPC è°ƒç”¨\nğŸ“ client/v3/
SDK --> GRPC : gRPC è°ƒç”¨\nğŸ“ client/v3/
HTTP --> REST : HTTP è¯·æ±‚\nğŸ“ client/v2/
REST --> GRPC : è½¬æ¢ä¸º gRPC\nğŸ“ grpc-gateway

' APIå±‚åˆ°æ ¸å¿ƒå±‚çš„è¿æ¥
GRPC --> AUTH : è®¤è¯æ£€æŸ¥\nğŸ“ v3rpc/interceptor.go
AUTH --> ETCD : è½¬å‘è¯·æ±‚\nğŸ“ server/etcdserver/
ETCD --> RAFT : ä¸€è‡´æ€§å¤„ç†\nğŸ“ server/etcdserver/raft.go
ETCD --> APPLY : åº”ç”¨æ“ä½œ\nğŸ“ server/etcdserver/apply/
ETCD --> CLUSTER : é›†ç¾¤ç®¡ç†\nğŸ“ api/membership/

' æ ¸å¿ƒå±‚åˆ°å­˜å‚¨å±‚çš„è¿æ¥
RAFT --> WAL : æ—¥å¿—å†™å…¥\nğŸ“ raft/ â†’ storage/wal/
APPLY --> MVCC : çŠ¶æ€æ›´æ–°\nğŸ“ apply/ â†’ storage/mvcc/
MVCC --> BACKEND : æ•°æ®æŒä¹…åŒ–\nğŸ“ mvcc/ â†’ backend/
RAFT --> SNAP : å¿«ç…§åˆ›å»º\nğŸ“ raft/ â†’ storage/snap/

' åŸºç¡€è®¾æ–½è¿æ¥
ETCD --> LEASE : ç§Ÿçº¦ç®¡ç†\nğŸ“ server/lease/
ETCD --> WATCH : äº‹ä»¶ç›‘å¬\nğŸ“ storage/mvcc/watcher.go
ETCD --> AUTHSYS : æƒé™éªŒè¯\nğŸ“ server/auth/

note bottom
  ä»£ç å®ç°ä½ç½®è¯´æ˜:
  
  ğŸ“ è¡¨ç¤ºä¸»è¦æºç æ–‡ä»¶è·¯å¾„
  â†’ è¡¨ç¤ºæ¨¡å—é—´çš„è°ƒç”¨å…³ç³»
  
  å…³é”®ç›®å½•ç»“æ„:
  - server/: æœåŠ¡ç«¯æ ¸å¿ƒå®ç°
  - client/: å®¢æˆ·ç«¯ SDK å®ç°
  - raft/: Raft ç®—æ³•å®ç°
  - api/: API å®šä¹‰å’ŒæœåŠ¡
  - storage/: å­˜å‚¨å¼•æ“å®ç°
  
  ä¸»è¦å…¥å£æ–‡ä»¶:
  - server/etcdmain/main.go: æœåŠ¡ç«¯å¯åŠ¨
  - etcdctl/main.go: å®¢æˆ·ç«¯å·¥å…·
  - client/v3/client.go: SDK å…¥å£
end note

@enduml
