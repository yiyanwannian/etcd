@startuml etcd-core-algorithms-datastructures
!theme plain
title etcd æ ¸å¿ƒç®—æ³•ä¸æ•°æ®ç»“æ„è®¾è®¡

' ===== Raft ä¸€è‡´æ€§ç®—æ³•æ ¸å¿ƒ =====
package "Raft ä¸€è‡´æ€§ç®—æ³• Raft Consensus Algorithm" {
  
  class "RaftCore" as RAFT_CORE {
    -state: StateType
    -term: uint64
    -vote: uint64
    -lead: uint64
    -raftLog: *raftLog
    -prs: tracker.ProgressTracker
    +Step(m pb.Message)
    +tick()
    +campaign()
    --
    ğŸ“ raft/raft.go:raft
    ç®—æ³•æ ¸å¿ƒ: Raft çŠ¶æ€æœº
  }
  
  enum "StateType" as STATE_TYPE {
    StateFollower
    StateCandidate
    StateLeader
    StatePreCandidate
    --
    çŠ¶æ€è½¬æ¢é©±åŠ¨ç®—æ³•æ‰§è¡Œ
  }
  
  class "RaftLog" as RAFT_LOG {
    -storage: Storage
    -unstable: unstable
    -committed: uint64
    -applied: uint64
    +append(ents ...pb.Entry)
    +maybeAppend()
    +findConflict()
    --
    ğŸ“ raft/log.go:raftLog
    æ•°æ®ç»“æ„: åˆ†æ®µæ—¥å¿—å­˜å‚¨
  }
  
  class "ProgressTracker" as PROGRESS_TRACKER {
    -prs: map[uint64]*Progress
    -votes: map[uint64]bool
    -maxInflight: int
    +RecordVote()
    +TallyVotes()
    --
    ğŸ“ raft/tracker/progress.go
    ç®—æ³•ä¼˜åŒ–: æµæ§å’Œè¿›åº¦è·Ÿè¸ª
  }
  
  RAFT_CORE --> STATE_TYPE : çŠ¶æ€ç®¡ç†
  RAFT_CORE --> RAFT_LOG : æ—¥å¿—ç®¡ç†
  RAFT_CORE --> PROGRESS_TRACKER : è¿›åº¦è·Ÿè¸ª
  
  note right of RAFT_CORE
    Raft ç®—æ³•è®¾è®¡è¦ç‚¹:
    
    1. å¼ºé¢†å¯¼è€…æ¨¡å‹
       - æ‰€æœ‰å†™æ“ä½œé€šè¿‡ Leader
       - ç®€åŒ–ä¸€è‡´æ€§ä¿è¯
    
    2. é¢†å¯¼è€…é€‰ä¸¾
       - éšæœºè¶…æ—¶é¿å…åˆ†ç¥¨
       - ä»»æœŸå·å•è°ƒé€’å¢
    
    3. æ—¥å¿—å¤åˆ¶
       - é¡ºåºä¸€è‡´æ€§ä¿è¯
       - å¤šæ•°æ´¾ç¡®è®¤æäº¤
    
    4. å®‰å…¨æ€§ä¿è¯
       - é€‰ä¸¾å®‰å…¨æ€§
       - æ—¥å¿—åŒ¹é…æ€§
       - é¢†å¯¼è€…å®Œæ•´æ€§
  end note
}

' ===== MVCC å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ =====
package "MVCC å­˜å‚¨å¼•æ“ MVCC Storage Engine" {
  
  class "MVCCStore" as MVCC_STORE {
    -kvindex: index
    -backend: backend.Backend
    -currentRev: int64
    -compactMainRev: int64
    +Put(key, value []byte, lease LeaseID)
    +Range(key, end []byte, ro RangeOptions)
    +DeleteRange(key, end []byte)
    --
    ğŸ“ server/storage/mvcc/kvstore.go:store
    æ ¸å¿ƒ: å¤šç‰ˆæœ¬å­˜å‚¨å¼•æ“
  }
  
  class "TreeIndex" as TREE_INDEX {
    -tree: *btree.BTree
    -lg: *zap.Logger
    +Get(key []byte): *keyIndex
    +Put(key []byte, rev revision)
    +Range(key, end []byte): [][]byte
    +Compact(rev int64)
    --
    ğŸ“ server/storage/mvcc/index.go:treeIndex
    æ•°æ®ç»“æ„: B+ æ ‘ç´¢å¼•
  }
  
  class "KeyIndex" as KEY_INDEX {
    -key: []byte
    -modified: revision
    -generations: []generation
    +put(rev revision)
    +get(atRev int64): *revision
    +tombstone(rev revision)
    --
    ğŸ“ server/storage/mvcc/key_index.go:keyIndex
    æ•°æ®ç»“æ„: é”®ç‰ˆæœ¬é“¾è¡¨
  }
  
  class "Generation" as GENERATION {
    -ver: int64
    -created: revision
    -revs: []revision
    +walk(f func(rev revision) bool)
    +isEmpty(): bool
    --
    ğŸ“ server/storage/mvcc/key_index.go:generation
    æ•°æ®ç»“æ„: ç‰ˆæœ¬ä»£ç®¡ç†
  }
  
  class "Revision" as REVISION {
    -main: int64
    -sub: int64
    +GreaterThan(b revision): bool
    +String(): string
    --
    ğŸ“ server/storage/mvcc/revision.go:revision
    æ•°æ®ç»“æ„: é€»è¾‘æ—¶é’Ÿ
  }
  
  MVCC_STORE --> TREE_INDEX : ç´¢å¼•ç®¡ç†
  TREE_INDEX --> KEY_INDEX : é”®ç´¢å¼•
  KEY_INDEX --> GENERATION : ç‰ˆæœ¬ä»£
  GENERATION --> REVISION : ç‰ˆæœ¬å·
  
  note right of MVCC_STORE
    MVCC è®¾è®¡è¦ç‚¹:
    
    1. ç‰ˆæœ¬å·è®¾è®¡
       - å…¨å±€é€’å¢ç‰ˆæœ¬å·
       - é€»è¾‘æ—¶é’Ÿä¿è¯é¡ºåº
    
    2. ç´¢å¼•ç»“æ„
       - B+ æ ‘å¿«é€ŸæŸ¥æ‰¾
       - ç‰ˆæœ¬é“¾è¡¨å†å²æŸ¥è¯¢
    
    3. å¹¶å‘æ§åˆ¶
       - è¯»ä¸é˜»å¡å†™
       - å†™ä¸é˜»å¡è¯»
       - å¿«ç…§éš”ç¦»çº§åˆ«
    
    4. ç©ºé—´ç®¡ç†
       - å®šæœŸå‹ç¼©å†å²ç‰ˆæœ¬
       - å¢“ç¢‘æ ‡è®°åˆ é™¤
  end note
}

' ===== Watch äº‹ä»¶ç³»ç»Ÿ =====
package "Watch äº‹ä»¶ç³»ç»Ÿ Watch Event System" {
  
  class "WatchableStore" as WATCHABLE_STORE {
    -store: *store
    -synced: watcherGroup
    -unsynced: watcherGroup
    -victims: []watcherBatch
    +watch(key, end []byte, startRev int64): *watcher
    +notify(rev int64, evs []mvccpb.Event)
    +syncWatchers(): int
    --
    ğŸ“ server/storage/mvcc/watchable_store.go:watchableStore
    è®¾è®¡æ¨¡å¼: è§‚å¯Ÿè€…æ¨¡å¼
  }
  
  class "WatcherGroup" as WATCHER_GROUP {
    -keyWatchers: map[string]watcherSet
    -ranges: adt.IntervalTree
    +add(wa *watcher)
    +delete(wa *watcher)
    +choose(maxWatchers int): watcherSet
    --
    ğŸ“ server/storage/mvcc/watcher_group.go:watcherGroup
    æ•°æ®ç»“æ„: åŒºé—´æ ‘ä¼˜åŒ–
  }
  
  class "Watcher" as WATCHER {
    -key: []byte
    -end: []byte
    -minRev: int64
    -id: WatchID
    -ch: chan<- WatchResponse
    -fcs: []FilterFunc
    +send(wr WatchResponse): bool
    --
    ğŸ“ server/storage/mvcc/watcher.go:watcher
    æ ¸å¿ƒ: äº‹ä»¶ç›‘å¬å™¨
  }
  
  class "IntervalTree" as INTERVAL_TREE {
    +Insert(item Item)
    +Delete(item Item)
    +Query(r Interval): []Item
    --
    ğŸ“ github.com/google/btree
    ç®—æ³•: åŒºé—´æ ‘èŒƒå›´æŸ¥è¯¢
  }
  
  WATCHABLE_STORE --> WATCHER_GROUP : åˆ†ç»„ç®¡ç†
  WATCHER_GROUP --> WATCHER : ç›‘å¬å™¨
  WATCHER_GROUP --> INTERVAL_TREE : èŒƒå›´æŸ¥è¯¢
  
  note right of WATCHABLE_STORE
    Watch ç³»ç»Ÿè®¾è®¡è¦ç‚¹:
    
    1. äº‹ä»¶åˆ†å‘
       - å¼‚æ­¥äº‹ä»¶é€šçŸ¥
       - æ‰¹é‡äº‹ä»¶å¤„ç†
    
    2. æ€§èƒ½ä¼˜åŒ–
       - åŒºé—´æ ‘èŒƒå›´æŸ¥è¯¢
       - ç›‘å¬å™¨åˆ†ç»„ç®¡ç†
    
    3. èƒŒå‹æ§åˆ¶
       - æ…¢æ¶ˆè´¹è€…éš”ç¦»
       - å—å®³è€…æœºåˆ¶
    
    4. è¿‡æ»¤æœºåˆ¶
       - å®¢æˆ·ç«¯è¿‡æ»¤å™¨
       - å‡å°‘ç½‘ç»œä¼ è¾“
  end note
}

' ===== Lease ç§Ÿçº¦ç³»ç»Ÿ =====
package "Lease ç§Ÿçº¦ç³»ç»Ÿ Lease Management System" {
  
  class "Lessor" as LESSOR {
    -leaseMap: map[LeaseID]*Lease
    -leaseExpiredNotifier: *LeaseExpiredNotifier
    -leaseCheckpointHeap: LeaseQueue
    +Grant(id LeaseID, ttl int64): *Lease
    +Revoke(id LeaseID): error
    +Renew(id LeaseID): int64
    +runLoop()
    --
    ğŸ“ server/lease/lessor.go:lessor
    æ ¸å¿ƒ: ç§Ÿçº¦ç”Ÿå‘½å‘¨æœŸç®¡ç†
  }
  
  class "LeaseQueue" as LEASE_QUEUE {
    -array: []*LeaseWithTime
    -idxMap: map[LeaseID]int
    +RegisterOrUpdate(item *LeaseWithTime)
    +Poll(): *LeaseWithTime
    +heapifyUp(j int)
    +heapifyDown(i int)
    --
    ğŸ“ server/lease/lease_queue.go:leaseQueue
    æ•°æ®ç»“æ„: æœ€å°å †
  }
  
  class "Lease" as LEASE {
    -ID: LeaseID
    -ttl: int64
    -remainingTTL: int64
    -expiryTime: time.Time
    -itemSet: map[LeaseItem]struct{}
    +expired(): bool
    +Keys(): []string
    --
    ğŸ“ server/lease/lease.go:Lease
    æ•°æ®ç»“æ„: ç§Ÿçº¦å¯¹è±¡
  }
  
  LESSOR --> LEASE_QUEUE : è¿‡æœŸç®¡ç†
  LESSOR --> LEASE : ç§Ÿçº¦ç®¡ç†
  LEASE_QUEUE --> LEASE : å †å…ƒç´ 
  
  note right of LESSOR
    Lease ç³»ç»Ÿè®¾è®¡è¦ç‚¹:
    
    1. æ—¶é—´ç®¡ç†
       - æœ€å°å †ç®¡ç†è¿‡æœŸæ—¶é—´
       - é«˜æ•ˆçš„è¿‡æœŸæ£€æµ‹
    
    2. ç”Ÿå‘½å‘¨æœŸ
       - åˆ›å»ºã€ç»­æœŸã€æ’¤é”€
       - è‡ªåŠ¨è¿‡æœŸå¤„ç†
    
    3. é”®å€¼å…³è”
       - ç§Ÿçº¦ç»‘å®šé”®å€¼å¯¹
       - çº§è”åˆ é™¤æœºåˆ¶
    
    4. æ£€æŸ¥ç‚¹æœºåˆ¶
       - å®šæœŸæŒä¹…åŒ–çŠ¶æ€
       - æ•…éšœæ¢å¤æ”¯æŒ
  end note
}

' ===== ç½‘ç»œä¼ è¾“ä¼˜åŒ– =====
package "ç½‘ç»œä¼ è¾“ Network Transport" {
  
  class "Transport" as TRANSPORT {
    -peers: map[types.ID]Peer
    -pipelineRt: http.RoundTripper
    -streamRt: http.RoundTripper
    +Send(msgs []raftpb.Message)
    +AddPeer(id types.ID, urls []string)
    --
    ğŸ“ server/etcdserver/api/rafthttp/transport.go:Transport
    è®¾è®¡: å¤šç­–ç•¥ä¼ è¾“
  }
  
  class "Pipeline" as PIPELINE {
    -peerID: types.ID
    -tr: *Transport
    -msgc: chan raftpb.Message
    -wg: sync.WaitGroup
    +handle()
    +post(data []byte)
    --
    ğŸ“ server/etcdserver/api/rafthttp/pipeline.go:pipeline
    ç­–ç•¥: æ‰¹é‡ä¼ è¾“
  }
  
  class "Stream" as STREAM {
    -peerID: types.ID
    -msgAppV2Writer: *streamWriter
    -msgAppV2Reader: *streamReader
    +run()
    +write()
    +read()
    --
    ğŸ“ server/etcdserver/api/rafthttp/stream.go
    ç­–ç•¥: æµå¼ä¼ è¾“
  }
  
  TRANSPORT --> PIPELINE : æ‰¹é‡æ¶ˆæ¯
  TRANSPORT --> STREAM : é¢‘ç¹æ¶ˆæ¯
  
  note right of TRANSPORT
    ç½‘ç»œä¼ è¾“è®¾è®¡è¦ç‚¹:
    
    1. ä¼ è¾“ç­–ç•¥
       - Pipeline: æ‰¹é‡æ¶ˆæ¯
       - Stream: é¢‘ç¹å°æ¶ˆæ¯
       - Snapshot: å¤§æ–‡ä»¶ä¼ è¾“
    
    2. æ€§èƒ½ä¼˜åŒ–
       - è¿æ¥å¤ç”¨
       - æ‰¹é‡å‘é€
       - å‹ç¼©ä¼ è¾“
    
    3. å®¹é”™æœºåˆ¶
       - è‡ªåŠ¨é‡è¿
       - è¶…æ—¶å¤„ç†
       - é”™è¯¯æ¢å¤
  end note
}

' ===== ç®—æ³•å¤æ‚åº¦åˆ†æ =====
note as COMPLEXITY_ANALYSIS
  æ ¸å¿ƒç®—æ³•å¤æ‚åº¦åˆ†æ:
  
  ğŸ” æŸ¥è¯¢æ“ä½œ:
  - ç‚¹æŸ¥è¯¢: O(log n) - B+ æ ‘æŸ¥æ‰¾
  - èŒƒå›´æŸ¥è¯¢: O(log n + k) - k ä¸ºç»“æœæ•°é‡
  - å†å²æŸ¥è¯¢: O(log n + m) - m ä¸ºç‰ˆæœ¬æ•°é‡
  
  âœï¸ å†™å…¥æ“ä½œ:
  - å•ç‚¹å†™å…¥: O(log n) - ç´¢å¼•æ›´æ–°
  - æ‰¹é‡å†™å…¥: O(k log n) - k ä¸ªæ“ä½œ
  - äº‹åŠ¡å†™å…¥: O(k log n) - åŸå­æ€§ä¿è¯
  
  ğŸ‘€ Watch æ“ä½œ:
  - æ³¨å†Œç›‘å¬: O(log n) - åŒºé—´æ ‘æ’å…¥
  - äº‹ä»¶åˆ†å‘: O(k) - k ä¸ºç›‘å¬å™¨æ•°é‡
  - èŒƒå›´ç›‘å¬: O(log n + k) - åŒºé—´æŸ¥è¯¢
  
  â° Lease æ“ä½œ:
  - åˆ›å»ºç§Ÿçº¦: O(log n) - å †æ’å…¥
  - ç»­æœŸç§Ÿçº¦: O(log n) - å †è°ƒæ•´
  - è¿‡æœŸæ£€æŸ¥: O(1) - å †é¡¶æŸ¥çœ‹
  
  ğŸ”„ Raft æ“ä½œ:
  - æ—¥å¿—è¿½åŠ : O(1) - é¡ºåºå†™å…¥
  - æ—¥å¿—å¤åˆ¶: O(m) - m ä¸ºèŠ‚ç‚¹æ•°é‡
  - é€‰ä¸¾æŠ•ç¥¨: O(m) - å¹¿æ’­æŠ•ç¥¨
end note

@enduml
