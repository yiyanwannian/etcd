@startuml auth-security-model-code
!theme plain
title etcd è®¤è¯å®‰å…¨æ¨¡å‹ - ä»£ç å®ç°ä½ç½®

package "è®¤è¯å­˜å‚¨ Auth Store" {
  interface AuthStore {
    +AuthEnable(): error
    +AuthDisable(): error
    +IsAuthEnabled(): bool
    +Authenticate(): (*pb.AuthenticateResponse, error)
    +UserAdd(): (*pb.AuthUserAddResponse, error)
    +UserDelete(): (*pb.AuthUserDeleteResponse, error)
    +UserChangePassword(): (*pb.AuthUserChangePasswordResponse, error)
    +UserGrantRole(): (*pb.AuthUserGrantRoleResponse, error)
    +UserGet(): (*pb.AuthUserGetResponse, error)
    +UserRevokeRole(): (*pb.AuthUserRevokeRoleResponse, error)
    +UserList(): (*pb.AuthUserListResponse, error)
    +RoleAdd(): (*pb.AuthRoleAddResponse, error)
    +RoleGrantPermission(): (*pb.AuthRoleGrantPermissionResponse, error)
    +RoleGet(): (*pb.AuthRoleGetResponse, error)
    +RoleRevokePermission(): (*pb.AuthRoleRevokePermissionResponse, error)
    +RoleDelete(): (*pb.AuthRoleDeleteResponse, error)
    +RoleList(): (*pb.AuthRoleListResponse, error)
    +IsAdminPermitted(): error
    +IsMemberAllowed(): error
    +IsRangePermitted(): error
    +IsPutPermitted(): error
    +IsDeleteRangePermitted(): error
    --
    ğŸ“ server/auth/store.go:AuthStore
    ğŸ“ server/auth/store.go:(*authStore).AuthEnable()
    ğŸ“ server/auth/store.go:(*authStore).Authenticate()
    ğŸ“ server/auth/store.go:(*authStore).UserAdd()
    ğŸ“ server/auth/store.go:(*authStore).RoleAdd()
    ğŸ“ server/auth/store.go:(*authStore).IsRangePermitted()
  }
  
  class authStore {
    +be: backend.Backend
    +enabled: bool
    +enabledMu: sync.RWMutex
    +rangePermCache: map[string]*unifiedRangePermissions
    +tokenProvider: TokenProvider
    +bcryptCost: int
    +lg: *zap.Logger
    --
    ğŸ“ server/auth/store.go:authStore
    ğŸ“ server/auth/store.go:NewAuthStore()
    ğŸ“ server/auth/store.go:(*authStore).AuthEnable()
    ğŸ“ server/auth/store.go:(*authStore).AuthDisable()
    ğŸ“ server/auth/store.go:(*authStore).Authenticate()
    ğŸ“ server/auth/store.go:(*authStore).getUser()
    ğŸ“ server/auth/store.go:(*authStore).getRole()
  }
}

package "ç”¨æˆ·ç®¡ç† User Management" {
  class User {
    +Name: []byte
    +Password: []byte
    +Roles: []string
    +Options: *UserAddOptions
    --
    ğŸ“ api/authpb/auth.proto:User
    ğŸ“ server/auth/store.go:(*authStore).UserAdd()
    ğŸ“ server/auth/store.go:(*authStore).UserDelete()
    ğŸ“ server/auth/store.go:(*authStore).UserChangePassword()
    ğŸ“ server/auth/store.go:(*authStore).UserGrantRole()
  }
  
  class UserAddOptions {
    +NoPassword: bool
    --
    ğŸ“ api/authpb/auth.proto:UserAddOptions
  }
}

package "è§’è‰²ç®¡ç† Role Management" {
  class Role {
    +Name: []byte
    +KeyPermission: []*authpb.Permission
    --
    ğŸ“ api/authpb/auth.proto:Role
    ğŸ“ server/auth/store.go:(*authStore).RoleAdd()
    ğŸ“ server/auth/store.go:(*authStore).RoleDelete()
    ğŸ“ server/auth/store.go:(*authStore).RoleGrantPermission()
    ğŸ“ server/auth/store.go:(*authStore).RoleRevokePermission()
  }
  
  class Permission {
    +PermType: Permission_Type
    +Key: []byte
    +RangeEnd: []byte
    --
    ğŸ“ api/authpb/auth.proto:Permission
    ğŸ“ server/auth/store.go:checkKeyPermission()
    ğŸ“ server/auth/store.go:checkRangePermission()
  }
  
  enum Permission_Type {
    READ
    WRITE
    READWRITE
    --
    ğŸ“ api/authpb/auth.proto:Permission_Type
  }
}

package "ä»¤ç‰Œç®¡ç† Token Management" {
  interface TokenProvider {
    +assign(): (string, error)
    +info(): (*AuthInfo, bool)
    +enable()
    +disable()
    +invalidateUser()
    +genTokenPrefix(): (string, error)
    --
    ğŸ“ server/auth/store.go:TokenProvider
    ğŸ“ server/auth/simple_token.go:(*simpleTokenTTLKeeper).assign()
    ğŸ“ server/auth/jwt.go:(*jwtTokenProvider).assign()
  }
  
  class simpleTokenTTLKeeper {
    +tokens: map[string]time.Time
    +donec: chan struct{}
    +stopc: chan struct{}
    +deleteTokenFunc: func(string)
    +mu: *sync.RWMutex
    +addSimpleToken()
    +resetSimpleToken()
    +deleteSimpleToken()
    --
    ğŸ“ server/auth/simple_token.go:simpleTokenTTLKeeper
    ğŸ“ server/auth/simple_token.go:newSimpleTokenTTLKeeper()
    ğŸ“ server/auth/simple_token.go:(*simpleTokenTTLKeeper).assign()
    ğŸ“ server/auth/simple_token.go:(*simpleTokenTTLKeeper).info()
    ğŸ“ server/auth/simple_token.go:(*simpleTokenTTLKeeper).run()
  }
  
  class jwtTokenProvider {
    +signingMethod: jwt.SigningMethod
    +key: interface{}
    +ttl: time.Duration
    +verifyOnly: bool
    --
    ğŸ“ server/auth/jwt.go:jwtTokenProvider
    ğŸ“ server/auth/jwt.go:newJWTTokenProvider()
    ğŸ“ server/auth/jwt.go:(*jwtTokenProvider).assign()
    ğŸ“ server/auth/jwt.go:(*jwtTokenProvider).info()
    ğŸ“ github.com/golang-jwt/jwt/v4
  }
  
  class AuthInfo {
    +Username: string
    +Roles: []string
    +Revision: uint64
    --
    ğŸ“ server/auth/store.go:AuthInfo
  }
}

package "æƒé™ç¼“å­˜ Permission Cache" {
  class unifiedRangePermissions {
    +readPerms: adt.IntervalTree
    +writePerms: adt.IntervalTree
    --
    ğŸ“ server/auth/range_perm_cache.go:unifiedRangePermissions
    ğŸ“ server/auth/range_perm_cache.go:(*unifiedRangePermissions).add()
    ğŸ“ server/auth/range_perm_cache.go:(*unifiedRangePermissions).check()
  }
  
  class adt.IntervalTree {
    +Insert()
    +Delete()
    +Query()
    +Len()
    --
    ğŸ“ github.com/google/btree
    ğŸ“ server/auth/range_perm_cache.go:newIntervalPermission()
  }
}

package "TLS å®‰å…¨ TLS Security" {
  class TLSInfo {
    +CertFile: string
    +KeyFile: string
    +TrustedCAFile: string
    +ClientCertAuth: bool
    +CRLFile: string
    +InsecureSkipVerify: bool
    +ServerName: string
    +CipherSuites: []uint16
    +AllowedCN: string
    +AllowedHostname: string
    +Logger: *zap.Logger
    +EmptyCN: bool
    --
    ğŸ“ pkg/transport/listener.go:TLSInfo
    ğŸ“ pkg/transport/listener.go:(*TLSInfo).ClientConfig()
    ğŸ“ pkg/transport/listener.go:(*TLSInfo).ServerConfig()
    ğŸ“ pkg/transport/listener.go:(*TLSInfo).baseConfig()
  }
}

' å…³ç³»è¿æ¥
authStore --> AuthStore : å®ç°\nğŸ“ server/auth/store.go
authStore --> User : ç®¡ç†ç”¨æˆ·\nğŸ“ server/auth/store.go
authStore --> Role : ç®¡ç†è§’è‰²\nğŸ“ server/auth/store.go
authStore --> TokenProvider : ä»¤ç‰Œæä¾›è€…\nğŸ“ server/auth/store.go
authStore --> unifiedRangePermissions : æƒé™ç¼“å­˜\nğŸ“ server/auth/range_perm_cache.go

Role --> Permission : åŒ…å«æƒé™\nğŸ“ api/authpb/auth.proto
Permission --> Permission_Type : æƒé™ç±»å‹\nğŸ“ api/authpb/auth.proto

TokenProvider --> simpleTokenTTLKeeper : Simple Token å®ç°\nğŸ“ server/auth/simple_token.go
TokenProvider --> jwtTokenProvider : JWT Token å®ç°\nğŸ“ server/auth/jwt.go
TokenProvider --> AuthInfo : ç”Ÿæˆè®¤è¯ä¿¡æ¯\nğŸ“ server/auth/store.go

unifiedRangePermissions --> adt.IntervalTree : åŒºé—´æ ‘å­˜å‚¨\nğŸ“ server/auth/range_perm_cache.go

note right of authStore
  è®¤è¯å­˜å‚¨æ ¸å¿ƒå®ç°:
  ğŸ“ server/auth/store.go
  
  å…³é”®æ–¹æ³•:
  - NewAuthStore(): åˆ›å»ºè®¤è¯å­˜å‚¨
  - AuthEnable(): å¯ç”¨è®¤è¯
  - Authenticate(): ç”¨æˆ·è®¤è¯
  - UserAdd(): æ·»åŠ ç”¨æˆ·
  - RoleAdd(): æ·»åŠ è§’è‰²
  - IsRangePermitted(): æƒé™æ£€æŸ¥
  
  å­˜å‚¨æ¡¶:
  - authUsersBucketName: ç”¨æˆ·å­˜å‚¨
  - authRolesBucketName: è§’è‰²å­˜å‚¨
  - authRevisionBucketName: ç‰ˆæœ¬å­˜å‚¨
end note

note right of simpleTokenTTLKeeper
  ç®€å•ä»¤ç‰Œç®¡ç†å®ç°:
  ğŸ“ server/auth/simple_token.go
  
  æ ¸å¿ƒåŠŸèƒ½:
  - assign(): åˆ†é…ä»¤ç‰Œ
  - info(): è·å–ä»¤ç‰Œä¿¡æ¯
  - run(): TTL æ¸…ç†å¾ªç¯
  - addSimpleToken(): æ·»åŠ ä»¤ç‰Œ
  - resetSimpleToken(): é‡ç½®ä»¤ç‰Œ
  
  ç‰¹ç‚¹:
  - å†…å­˜å­˜å‚¨
  - TTL è¿‡æœŸç®¡ç†
  - å®šæ—¶æ¸…ç†
  - å¿«é€ŸéªŒè¯
end note

note right of jwtTokenProvider
  JWT ä»¤ç‰Œç®¡ç†å®ç°:
  ğŸ“ server/auth/jwt.go
  
  ä¾èµ–åº“:
  ğŸ“ github.com/golang-jwt/jwt/v4
  
  æ ¸å¿ƒåŠŸèƒ½:
  - assign(): ç”Ÿæˆ JWT ä»¤ç‰Œ
  - info(): éªŒè¯ JWT ä»¤ç‰Œ
  - parseWithClaims(): è§£æå£°æ˜
  
  ç‰¹ç‚¹:
  - æ•°å­—ç­¾åéªŒè¯
  - æ— çŠ¶æ€è®¾è®¡
  - æ ‡å‡†å…¼å®¹
  - å®‰å…¨å¯é 
end note

note right of unifiedRangePermissions
  æƒé™ç¼“å­˜ä¼˜åŒ–å®ç°:
  ğŸ“ server/auth/range_perm_cache.go
  
  æ ¸å¿ƒåŠŸèƒ½:
  - add(): æ·»åŠ æƒé™èŒƒå›´
  - check(): æ£€æŸ¥æƒé™
  - getMergedPerms(): åˆå¹¶æƒé™
  
  æ•°æ®ç»“æ„:
  - IntervalTree: åŒºé—´æ ‘å­˜å‚¨
  - æ”¯æŒèŒƒå›´æƒé™æŸ¥è¯¢
  - å†…å­˜é«˜æ•ˆ
  - å¿«é€ŸæŸ¥æ‰¾
end note

' RBAC å…³ç³»å›¾
package "RBAC æ¨¡å‹å®ç° RBAC Model Implementation" {
  class "ç”¨æˆ·å­˜å‚¨ User Storage" as UserStorage {
    --
    ğŸ“ server/auth/store.go:getUser()
    ğŸ“ server/auth/store.go:putUser()
    ğŸ“ server/auth/store.go:delUser()
    
    å­˜å‚¨æ¡¶: authUsersBucketName
    é”®æ ¼å¼: username
    å€¼æ ¼å¼: User protobuf
  }
  
  class "è§’è‰²å­˜å‚¨ Role Storage" as RoleStorage {
    --
    ğŸ“ server/auth/store.go:getRole()
    ğŸ“ server/auth/store.go:putRole()
    ğŸ“ server/auth/store.go:delRole()
    
    å­˜å‚¨æ¡¶: authRolesBucketName
    é”®æ ¼å¼: rolename
    å€¼æ ¼å¼: Role protobuf
  }
  
  class "æƒé™æ£€æŸ¥ Permission Check" as PermCheck {
    --
    ğŸ“ server/auth/store.go:IsRangePermitted()
    ğŸ“ server/auth/store.go:IsPutPermitted()
    ğŸ“ server/auth/store.go:IsDeleteRangePermitted()
    
    æ£€æŸ¥æµç¨‹:
    1. è·å–ç”¨æˆ·è§’è‰²
    2. éå†è§’è‰²æƒé™
    3. åŒ¹é…é”®èŒƒå›´
    4. è¿”å›æ£€æŸ¥ç»“æœ
  }
}

UserStorage ||--o{ RoleStorage : ç”¨æˆ·åˆ†é…è§’è‰²\nğŸ“ server/auth/store.go
RoleStorage ||--o{ PermCheck : è§’è‰²åŒ…å«æƒé™\nğŸ“ server/auth/store.go

note right of TLSInfo
  TLS å®‰å…¨é…ç½®å®ç°:
  ğŸ“ pkg/transport/listener.go
  
  æ ¸å¿ƒåŠŸèƒ½:
  - ClientConfig(): å®¢æˆ·ç«¯ TLS é…ç½®
  - ServerConfig(): æœåŠ¡ç«¯ TLS é…ç½®
  - baseConfig(): åŸºç¡€ TLS é…ç½®
  - NewListener(): åˆ›å»º TLS ç›‘å¬å™¨
  
  å®‰å…¨ç‰¹æ€§:
  - åŒå‘è®¤è¯
  - è¯ä¹¦éªŒè¯
  - åŠ å¯†é€šä¿¡
  - è®¿é—®æ§åˆ¶
end note

note as N1
  è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹:
  
  1. server/etcdserver/server.go:NewServer()
     â†“
  2. server/auth/store.go:NewAuthStore()
     â†“
  3. server/auth/simple_token.go:newSimpleTokenTTLKeeper()
     æˆ– server/auth/jwt.go:newJWTTokenProvider()
     â†“
  4. server/auth/range_perm_cache.go:newUnifiedRangePermissions()
  
  API é›†æˆ:
  ğŸ“ server/etcdserver/api/v3rpc/auth.go
  ğŸ“ server/etcdserver/api/v3rpc/interceptor.go
  
  æƒé™æ£€æŸ¥æ‹¦æˆªå™¨:
  - authUnaryInterceptor(): ä¸€å…ƒ RPC æ‹¦æˆª
  - authStreamInterceptor(): æµå¼ RPC æ‹¦æˆª
end note

@enduml
