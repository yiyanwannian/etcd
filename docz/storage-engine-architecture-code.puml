@startuml storage-engine-architecture-code
!theme plain
title etcd å­˜å‚¨å¼•æ“æ¶æ„å›¾ - ä»£ç å®ç°ä½ç½®

package "MVCC å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶" {
  class store {
    +ReadView
    +WriteView
    +b: backend.Backend
    +kvindex: index
    +currentRev: int64
    +compactMainRev: int64
    +Put()
    +Range()
    +DeleteRange()
    +Txn()
    +Compact()
    --
    ğŸ“ server/storage/mvcc/kvstore.go:store
    ğŸ“ server/storage/mvcc/kvstore.go:(*store).Put()
    ğŸ“ server/storage/mvcc/kvstore.go:(*store).Range()
    ğŸ“ server/storage/mvcc/kvstore.go:(*store).DeleteRange()
    ğŸ“ server/storage/mvcc/kvstore_txn.go:(*storeTxnRead).Range()
    ğŸ“ server/storage/mvcc/kvstore_txn.go:(*storeTxnWrite).Put()
  }
  
  interface ReadView {
    +FirstRev(): int64
    +Rev(): int64
    +Range()
    --
    ğŸ“ server/storage/mvcc/kvstore.go:ReadView
    ğŸ“ server/storage/mvcc/kvstore.go:(*store).FirstRev()
    ğŸ“ server/storage/mvcc/kvstore.go:(*store).Rev()
  }
  
  interface WriteView {
    +DeleteRange()
    +Put()
    --
    ğŸ“ server/storage/mvcc/kvstore.go:WriteView
    ğŸ“ server/storage/mvcc/kvstore.go:(*store).Put()
    ğŸ“ server/storage/mvcc/kvstore.go:(*store).DeleteRange()
  }
  
  class watchableStore {
    +store
    +victims: []watcherBatch
    +unsynced: watcherGroup
    +synced: watcherGroup
    +notify()
    +syncWatchers()
    --
    ğŸ“ server/storage/mvcc/watchable_store.go:watchableStore
    ğŸ“ server/storage/mvcc/watchable_store.go:(*watchableStore).notify()
    ğŸ“ server/storage/mvcc/watchable_store.go:(*watchableStore).syncWatchers()
    ğŸ“ server/storage/mvcc/watchable_store.go:(*watchableStore).Watch()
  }
}

package "ç´¢å¼•ç®¡ç† Index Management" {
  interface index {
    +Get(): *keyIndex
    +Put()
    +Restore()
    +Range()
    +Compact()
    --
    ğŸ“ server/storage/mvcc/index.go:index
    ğŸ“ server/storage/mvcc/index.go:(*treeIndex).Get()
    ğŸ“ server/storage/mvcc/index.go:(*treeIndex).Put()
    ğŸ“ server/storage/mvcc/index.go:(*treeIndex).Range()
  }
  
  class treeIndex {
    +tree: *btree.BTree
    +lg: *zap.Logger
    --
    ğŸ“ server/storage/mvcc/index.go:treeIndex
    ğŸ“ server/storage/mvcc/index.go:newTreeIndex()
    ğŸ“ server/storage/mvcc/index.go:(*treeIndex).Get()
    ğŸ“ server/storage/mvcc/index.go:(*treeIndex).Put()
    ğŸ“ server/storage/mvcc/index.go:(*treeIndex).Compact()
    ğŸ“ github.com/google/btree
  }
  
  class keyIndex {
    +key: []byte
    +modified: revision
    +generations: []generation
    --
    ğŸ“ server/storage/mvcc/key_index.go:keyIndex
    ğŸ“ server/storage/mvcc/key_index.go:(*keyIndex).put()
    ğŸ“ server/storage/mvcc/key_index.go:(*keyIndex).get()
    ğŸ“ server/storage/mvcc/key_index.go:(*keyIndex).tombstone()
  }
  
  class generation {
    +ver: int64
    +created: revision
    +revs: []revision
    --
    ğŸ“ server/storage/mvcc/key_index.go:generation
    ğŸ“ server/storage/mvcc/key_index.go:(*generation).isEmpty()
    ğŸ“ server/storage/mvcc/key_index.go:(*generation).walk()
  }
}

package "åç«¯å­˜å‚¨ Backend Storage" {
  interface Backend {
    +ReadTx(): ReadTx
    +BatchTx(): BatchTx
    +ConcurrentReadTx(): ReadTx
    +Snapshot(): Snapshot
    +Hash(): uint32
    +Size(): int64
    +Defrag(): error
    +Close(): error
    --
    ğŸ“ server/storage/backend/backend.go:Backend
    ğŸ“ server/storage/backend/backend.go:(*backend).ReadTx()
    ğŸ“ server/storage/backend/backend.go:(*backend).BatchTx()
    ğŸ“ server/storage/backend/backend.go:(*backend).Snapshot()
  }
  
  class backend {
    +db: *bolt.DB
    +batchTx: *batchTxBuffered
    +readTx: *readTx
    +batchInterval: time.Duration
    +batchLimit: int
    +hooks: Hooks
    --
    ğŸ“ server/storage/backend/backend.go:backend
    ğŸ“ server/storage/backend/backend.go:newBackend()
    ğŸ“ server/storage/backend/backend.go:(*backend).begin()
    ğŸ“ server/storage/backend/backend.go:(*backend).defrag()
    ğŸ“ github.com/etcd-io/bbolt
  }
  
  interface BatchTx {
    +Lock()
    +Unlock()
    +UnsafeCreateBucket()
    +UnsafePut()
    +UnsafeSeqPut()
    +UnsafeDelete()
    +Commit()
    --
    ğŸ“ server/storage/backend/batch_tx.go:BatchTx
    ğŸ“ server/storage/backend/batch_tx.go:(*batchTx).UnsafePut()
    ğŸ“ server/storage/backend/batch_tx.go:(*batchTx).UnsafeRange()
    ğŸ“ server/storage/backend/batch_tx.go:(*batchTx).Commit()
  }
  
  class batchTxBuffered {
    +batchTx
    +buf: txWriteBuffer
    --
    ğŸ“ server/storage/backend/batch_tx.go:batchTxBuffered
    ğŸ“ server/storage/backend/batch_tx.go:(*batchTxBuffered).Commit()
    ğŸ“ server/storage/backend/batch_tx.go:(*batchTxBuffered).UnsafePut()
  }
}

package "WAL é¢„å†™æ—¥å¿—" {
  class WAL {
    +dir: string
    +metadata: []byte
    +state: raftpb.HardState
    +start: walpb.Snapshot
    +decoder: *decoder
    +encoder: *encoder
    +Save()
    +SaveSnapshot()
    +ReadAll()
    --
    ğŸ“ server/storage/wal/wal.go:WAL
    ğŸ“ server/storage/wal/wal.go:Create()
    ğŸ“ server/storage/wal/wal.go:Open()
    ğŸ“ server/storage/wal/wal.go:(*WAL).Save()
    ğŸ“ server/storage/wal/wal.go:(*WAL).SaveSnapshot()
    ğŸ“ server/storage/wal/wal.go:(*WAL).ReadAll()
  }
  
  class Record {
    +Type: int64
    +Crc: uint32
    +Data: []byte
    --
    ğŸ“ server/storage/wal/record.go:Record
    ğŸ“ server/storage/wal/encoder.go:(*encoder).encode()
    ğŸ“ server/storage/wal/decoder.go:(*decoder).decode()
  }
}

package "å¿«ç…§ç®¡ç† Snapshot" {
  class Snapshotter {
    +dir: string
    +Save()
    +Load()
    +LoadNewestAvailable()
    +ReleaseSnapDBs()
    --
    ğŸ“ server/storage/snap/snapshotter.go:Snapshotter
    ğŸ“ server/storage/snap/snapshotter.go:New()
    ğŸ“ server/storage/snap/snapshotter.go:(*Snapshotter).Save()
    ğŸ“ server/storage/snap/snapshotter.go:(*Snapshotter).Load()
    ğŸ“ server/storage/snap/snapshotter.go:(*Snapshotter).LoadNewestAvailable()
  }
  
  class Snapshot {
    +Data: []byte
    +Metadata: SnapshotMetadata
    --
    ğŸ“ server/storage/snap/snapshotter.go:Snapshot
    ğŸ“ server/storage/snap/db.go:(*Snapshot).NewDBSnapshot()
  }
}

' å…³ç³»è¿æ¥
store --> ReadView : å®ç°\nğŸ“ mvcc/kvstore.go
store --> WriteView : å®ç°\nğŸ“ mvcc/kvstore.go
watchableStore --> store : æ‰©å±•\nğŸ“ mvcc/watchable_store.go

store --> index : ä½¿ç”¨ç´¢å¼•\nğŸ“ mvcc/kvstore.go
treeIndex --> index : å®ç°\nğŸ“ mvcc/index.go
treeIndex --> keyIndex : ç®¡ç†\nğŸ“ mvcc/key_index.go
keyIndex --> generation : åŒ…å«\nğŸ“ mvcc/key_index.go

store --> Backend : ä½¿ç”¨åç«¯\nğŸ“ mvcc/kvstore.go
backend --> Backend : å®ç°\nğŸ“ backend/backend.go
backend --> BatchTx : åŒ…å«\nğŸ“ backend/batch_tx.go
batchTxBuffered --> BatchTx : å®ç°\nğŸ“ backend/batch_tx.go

backend --> WAL : æ—¥å¿—è®°å½•\nğŸ“ backend/ â†’ wal/
WAL --> Record : å†™å…¥è®°å½•\nğŸ“ wal/record.go

backend --> Snapshotter : å¿«ç…§ç®¡ç†\nğŸ“ backend/ â†’ snap/
Snapshotter --> Snapshot : åˆ›å»ºå¿«ç…§\nğŸ“ snap/snapshotter.go

note right of store
  MVCC å­˜å‚¨æ ¸å¿ƒå®ç°:
  ğŸ“ server/storage/mvcc/kvstore.go
  
  å…³é”®æ–¹æ³•:
  - Put(): å­˜å‚¨é”®å€¼å¯¹
  - Range(): èŒƒå›´æŸ¥è¯¢
  - DeleteRange(): åˆ é™¤èŒƒå›´
  - Compact(): å‹ç¼©å†å²ç‰ˆæœ¬
  
  äº‹åŠ¡æ”¯æŒ:
  ğŸ“ server/storage/mvcc/kvstore_txn.go
  - storeTxnRead: åªè¯»äº‹åŠ¡
  - storeTxnWrite: è¯»å†™äº‹åŠ¡
  - TxnRead(): åˆ›å»ºåªè¯»äº‹åŠ¡
  - TxnWrite(): åˆ›å»ºè¯»å†™äº‹åŠ¡
end note

note right of treeIndex
  B+ æ ‘ç´¢å¼•å®ç°:
  ğŸ“ server/storage/mvcc/index.go
  
  ä¾èµ–åº“:
  ğŸ“ github.com/google/btree
  
  å…³é”®åŠŸèƒ½:
  - Get(): è·å–é”®ç´¢å¼•
  - Put(): æ›´æ–°é”®ç´¢å¼•
  - Range(): èŒƒå›´æŸ¥è¯¢ç´¢å¼•
  - Compact(): å‹ç¼©ç´¢å¼•
  
  ç´¢å¼•ç»“æ„:
  ğŸ“ server/storage/mvcc/key_index.go
  - keyIndex: é”®ç´¢å¼•ç»“æ„
  - generation: ç‰ˆæœ¬ä»£ä¿¡æ¯
end note

note right of backend
  BoltDB åç«¯å®ç°:
  ğŸ“ server/storage/backend/backend.go
  
  ä¾èµ–åº“:
  ğŸ“ github.com/etcd-io/bbolt
  
  æ ¸å¿ƒåŠŸèƒ½:
  - newBackend(): åˆ›å»ºåç«¯
  - BatchTx(): æ‰¹é‡äº‹åŠ¡
  - ReadTx(): åªè¯»äº‹åŠ¡
  - Snapshot(): åˆ›å»ºå¿«ç…§
  - Defrag(): ç¢ç‰‡æ•´ç†
  
  äº‹åŠ¡å®ç°:
  ğŸ“ server/storage/backend/batch_tx.go
  - batchTx: åŸºç¡€æ‰¹é‡äº‹åŠ¡
  - batchTxBuffered: ç¼“å†²æ‰¹é‡äº‹åŠ¡
end note

note right of WAL
  é¢„å†™æ—¥å¿—å®ç°:
  ğŸ“ server/storage/wal/wal.go
  
  æ ¸å¿ƒåŠŸèƒ½:
  - Create(): åˆ›å»º WAL
  - Open(): æ‰“å¼€ WAL
  - Save(): ä¿å­˜è®°å½•
  - ReadAll(): è¯»å–æ‰€æœ‰è®°å½•
  
  ç¼–è§£ç :
  ğŸ“ server/storage/wal/encoder.go
  ğŸ“ server/storage/wal/decoder.go
  - encoder: è®°å½•ç¼–ç å™¨
  - decoder: è®°å½•è§£ç å™¨
  
  è®°å½•æ ¼å¼:
  ğŸ“ server/storage/wal/record.go
end note

note as N1
  å­˜å‚¨å¼•æ“åˆå§‹åŒ–æµç¨‹:
  
  1. server/etcdserver/server.go:NewServer()
     â†“
  2. server/storage/backend/backend.go:newBackend()
     â†“ 
  3. server/storage/mvcc/kvstore.go:NewStore()
     â†“
  4. server/storage/mvcc/index.go:newTreeIndex()
     â†“
  5. server/storage/mvcc/watchable_store.go:newWatchableStore()
  
  æ•°æ®è·¯å¾„:
  Put â†’ MVCC â†’ Backend â†’ BoltDB
  Get â†’ Index â†’ MVCC â†’ Backend â†’ BoltDB
  
  å…³é”®é…ç½®:
  - QuotaBackendBytes: åç«¯å­˜å‚¨é…é¢
  - BackendBatchLimit: æ‰¹å¤„ç†é™åˆ¶
  - BackendBatchInterval: æ‰¹å¤„ç†é—´éš”
end note

@enduml
