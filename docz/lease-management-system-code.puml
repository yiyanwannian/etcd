@startuml lease-management-system-code
!theme plain
title etcd ç§Ÿçº¦ç®¡ç†ç³»ç»Ÿ - ä»£ç å®ç°ä½ç½®

package "ç§Ÿçº¦ç®¡ç†å™¨ Lessor" {
  interface Lessor {
    +SetRangeDeleter()
    +SetCheckpointer()
    +Grant(): (*Lease, error)
    +Revoke(): error
    +Checkpoint(): error
    +Attach(): error
    +GetLease(): *Lease
    +Detach(): error
    +Promote()
    +Demote()
    +Renew(): (int64, error)
    +Lookup(): *Lease
    +Leases(): []*Lease
    +ExpiredLeasesC(): <-chan []*Lease
    +Recover(): error
    +Stop()
    --
    ğŸ“ server/lease/lessor.go:Lessor
    ğŸ“ server/lease/lessor.go:(*lessor).Grant()
    ğŸ“ server/lease/lessor.go:(*lessor).Revoke()
    ğŸ“ server/lease/lessor.go:(*lessor).Renew()
    ğŸ“ server/lease/lessor.go:(*lessor).Promote()
    ğŸ“ server/lease/lessor.go:(*lessor).Recover()
  }
  
  class lessor {
    +mu: sync.RWMutex
    +leaseMap: map[LeaseID]*Lease
    +leaseExpiredNotifier: *LeaseExpiredNotifier
    +leaseCheckpointHeap: LeaseQueue
    +b: backend.Backend
    +minLeaseTTL: int64
    +expiredC: chan []*Lease
    +stopC: chan struct{}
    +doneC: chan struct{}
    +lg: *zap.Logger
    +cp: Checkpointer
    +rd: RangeDeleter
    +primary: bool
    --
    ğŸ“ server/lease/lessor.go:lessor
    ğŸ“ server/lease/lessor.go:NewLessor()
    ğŸ“ server/lease/lessor.go:(*lessor).Grant()
    ğŸ“ server/lease/lessor.go:(*lessor).Revoke()
    ğŸ“ server/lease/lessor.go:(*lessor).runLoop()
    ğŸ“ server/lease/lessor.go:(*lessor).expireExists()
  }
}

package "ç§Ÿçº¦å¯¹è±¡ Lease Object" {
  class Lease {
    +ID: LeaseID
    +ttl: int64
    +remainingTTL: int64
    +expiryTime: time.Time
    +itemSet: map[LeaseItem]struct{}
    +revokec: chan struct{}
    +mu: sync.RWMutex
    +expired: bool
    --
    ğŸ“ server/lease/lease.go:Lease
    ğŸ“ server/lease/lease.go:(*Lease).expired()
    ğŸ“ server/lease/lease.go:(*Lease).persistTo()
    ğŸ“ server/lease/lease.go:(*Lease).Keys()
  }
  
  class LeaseItem {
    +Key: string
    --
    ğŸ“ server/lease/lease.go:LeaseItem
  }
  
  class LeaseID {
    +int64
    --
    ğŸ“ server/lease/lease.go:LeaseID
    ğŸ“ server/lease/lease.go:int64ToLeaseID()
    ğŸ“ server/lease/lease.go:LeaseID.String()
  }
}

package "ç§Ÿçº¦é˜Ÿåˆ— Lease Queue" {
  interface LeaseQueue {
    +RegisterOrUpdate(): 
    +Unregister(): *LeaseWithTime
    +Poll(): *LeaseWithTime
    +Len(): int
    --
    ğŸ“ server/lease/lease_queue.go:LeaseQueue
    ğŸ“ server/lease/lease_queue.go:(*leaseQueue).RegisterOrUpdate()
    ğŸ“ server/lease/lease_queue.go:(*leaseQueue).Poll()
    ğŸ“ server/lease/lease_queue.go:(*leaseQueue).Unregister()
  }
  
  class leaseQueue {
    +array: []*LeaseWithTime
    +idxMap: map[LeaseID]int
    +heapifyUp()
    +heapifyDown()
    +swap()
    --
    ğŸ“ server/lease/lease_queue.go:leaseQueue
    ğŸ“ server/lease/lease_queue.go:NewLeaseQueue()
    ğŸ“ server/lease/lease_queue.go:(*leaseQueue).heapifyUp()
    ğŸ“ server/lease/lease_queue.go:(*leaseQueue).heapifyDown()
    ğŸ“ server/lease/lease_queue.go:(*leaseQueue).swap()
  }
  
  class LeaseWithTime {
    +id: LeaseID
    +time: int64
    --
    ğŸ“ server/lease/lease_queue.go:LeaseWithTime
  }
  
  class LeaseExpiredNotifier {
    +m: map[LeaseID]*LeaseWithTime
    +queue: LeaseQueue
    +mu: sync.Mutex
    --
    ğŸ“ server/lease/lessor.go:LeaseExpiredNotifier
    ğŸ“ server/lease/lessor.go:(*LeaseExpiredNotifier).RegisterOrUpdate()
    ğŸ“ server/lease/lessor.go:(*LeaseExpiredNotifier).Unregister()
    ğŸ“ server/lease/lessor.go:(*LeaseExpiredNotifier).Poll()
  }
}

package "æ£€æŸ¥ç‚¹æœºåˆ¶ Checkpoint" {
  interface Checkpointer {
    +Checkpoint(): error
    +CheckpointBatch(): error
    --
    ğŸ“ server/lease/lessor.go:Checkpointer
    ğŸ“ server/etcdserver/server.go:(*EtcdServer).checkpointScheduledLeases()
  }
  
  class LeaseCheckpoint {
    +ID: LeaseID
    +RemainingTTL: int64
    --
    ğŸ“ api/leasepb/lease.proto:LeaseCheckpoint
    ğŸ“ server/lease/lessor.go:(*lessor).Checkpoint()
  }
  
  class checkpointer {
    +lg: *zap.Logger
    +backend: backend.Backend
    +cp: func(LeaseCheckpoint) error
    --
    ğŸ“ server/etcdserver/server.go:(*EtcdServer).checkpointScheduledLeases()
    ğŸ“ server/etcdserver/server.go:(*EtcdServer).triggerSnapshot()
  }
}

package "èŒƒå›´åˆ é™¤å™¨ Range Deleter" {
  interface RangeDeleter {
    +TxnDeleteRange(): (*pb.DeleteRangeResponse, error)
    --
    ğŸ“ server/lease/lessor.go:RangeDeleter
    ğŸ“ server/etcdserver/server.go:(*EtcdServer).applyEntryNormal()
  }
  
  class rangeDeleter {
    +store: mvcc.KV
    +lg: *zap.Logger
    --
    ğŸ“ server/etcdserver/server.go:(*EtcdServer).deleteLeasedKeys()
    ğŸ“ server/storage/mvcc/kvstore.go:(*store).DeleteRange()
  }
}

package "ç§Ÿçº¦æŒä¹…åŒ– Lease Persistence" {
  class leasepb.Lease {
    +ID: int64
    +TTL: int64
    --
    ğŸ“ api/leasepb/lease.proto:Lease
    ğŸ“ server/lease/lease.go:(*Lease).persistTo()
  }
  
  class leasepb.LeaseCheckpoint {
    +ID: int64
    +RemainingTTL: int64
    --
    ğŸ“ api/leasepb/lease.proto:LeaseCheckpoint
    ğŸ“ server/lease/lessor.go:(*lessor).Checkpoint()
  }
}

' å…³ç³»è¿æ¥
lessor --> Lessor : å®ç°\nğŸ“ server/lease/lessor.go
lessor --> Lease : ç®¡ç†ç§Ÿçº¦\nğŸ“ server/lease/lease.go
lessor --> LeaseExpiredNotifier : è¿‡æœŸé€šçŸ¥\nğŸ“ server/lease/lessor.go
lessor --> Checkpointer : æ£€æŸ¥ç‚¹\nğŸ“ server/lease/lessor.go
lessor --> RangeDeleter : èŒƒå›´åˆ é™¤\nğŸ“ server/lease/lessor.go

Lease --> LeaseItem : åŒ…å«é¡¹ç›®\nğŸ“ server/lease/lease.go
Lease --> LeaseID : ç§Ÿçº¦æ ‡è¯†\nğŸ“ server/lease/lease.go

leaseQueue --> LeaseQueue : å®ç°\nğŸ“ server/lease/lease_queue.go
leaseQueue --> LeaseWithTime : é˜Ÿåˆ—å…ƒç´ \nğŸ“ server/lease/lease_queue.go
LeaseExpiredNotifier --> leaseQueue : ä½¿ç”¨é˜Ÿåˆ—\nğŸ“ server/lease/lessor.go

checkpointer --> Checkpointer : å®ç°\nğŸ“ server/etcdserver/server.go
checkpointer --> LeaseCheckpoint : æ£€æŸ¥ç‚¹æ•°æ®\nğŸ“ api/leasepb/lease.proto

rangeDeleter --> RangeDeleter : å®ç°\nğŸ“ server/etcdserver/server.go

lessor --> leasepb.Lease : æŒä¹…åŒ–\nğŸ“ api/leasepb/lease.proto
lessor --> leasepb.LeaseCheckpoint : æ£€æŸ¥ç‚¹æŒä¹…åŒ–\nğŸ“ api/leasepb/lease.proto

note right of lessor
  ç§Ÿçº¦ç®¡ç†å™¨æ ¸å¿ƒå®ç°:
  ğŸ“ server/lease/lessor.go
  
  å…³é”®æ–¹æ³•:
  - NewLessor(): åˆ›å»ºç§Ÿçº¦ç®¡ç†å™¨
  - Grant(): åˆ›å»ºç§Ÿçº¦
  - Revoke(): æ’¤é”€ç§Ÿçº¦
  - Renew(): ç»­çº¦
  - runLoop(): ä¸»è¿è¡Œå¾ªç¯
  - expireExists(): è¿‡æœŸæ£€æŸ¥
  
  ç”Ÿå‘½å‘¨æœŸç®¡ç†:
  - Promote(): æå‡ä¸ºä¸»èŠ‚ç‚¹
  - Demote(): é™çº§ä¸ºä»èŠ‚ç‚¹
  - Recover(): æ•…éšœæ¢å¤
end note

note right of leaseQueue
  æœ€å°å †å®ç°:
  ğŸ“ server/lease/lease_queue.go
  
  æ ¸å¿ƒç®—æ³•:
  - heapifyUp(): å‘ä¸Šè°ƒæ•´å †
  - heapifyDown(): å‘ä¸‹è°ƒæ•´å †
  - swap(): äº¤æ¢å…ƒç´ 
  
  ç‰¹ç‚¹:
  - æŒ‰è¿‡æœŸæ—¶é—´æ’åº
  - O(log n) æ’å…¥åˆ é™¤
  - O(1) è·å–æœ€æ—©è¿‡æœŸ
  - æ”¯æŒåŠ¨æ€æ›´æ–°
  
  æ•°æ®ç»“æ„:
  - array: å †æ•°ç»„
  - idxMap: ç´¢å¼•æ˜ å°„
end note

note right of LeaseExpiredNotifier
  è¿‡æœŸé€šçŸ¥å™¨å®ç°:
  ğŸ“ server/lease/lessor.go
  
  æ ¸å¿ƒåŠŸèƒ½:
  - RegisterOrUpdate(): æ³¨å†Œæˆ–æ›´æ–°ç§Ÿçº¦
  - Poll(): è·å–è¿‡æœŸç§Ÿçº¦
  - Unregister(): æ³¨é”€ç§Ÿçº¦
  
  ç‰¹ç‚¹:
  - å®šæ—¶æ£€æŸ¥è¿‡æœŸç§Ÿçº¦
  - æ‰¹é‡å¤„ç†è¿‡æœŸäº‹ä»¶
  - é«˜æ•ˆçš„æ—¶é—´ç®¡ç†
  - å†…å­˜ä¼˜åŒ–è®¾è®¡
end note

note right of checkpointer
  æ£€æŸ¥ç‚¹æœºåˆ¶å®ç°:
  ğŸ“ server/etcdserver/server.go
  
  ç›¸å…³æ–¹æ³•:
  - checkpointScheduledLeases(): å®šæœŸæ£€æŸ¥ç‚¹
  - triggerSnapshot(): è§¦å‘å¿«ç…§
  
  åŠŸèƒ½:
  - å®šæœŸä¿å­˜ç§Ÿçº¦çŠ¶æ€
  - æ•…éšœæ¢å¤æ”¯æŒ
  - æ‰¹é‡å¤„ç†ä¼˜åŒ–
  - æ•°æ®ä¸€è‡´æ€§ä¿è¯
  
  å­˜å‚¨ä½ç½®:
  - leaseCheckpointBucketName: æ£€æŸ¥ç‚¹æ¡¶
end note

note as N1
  ç§Ÿçº¦ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹:
  
  1. server/etcdserver/server.go:NewServer()
     â†“
  2. server/lease/lessor.go:NewLessor()
     â†“
  3. server/lease/lease_queue.go:NewLeaseQueue()
     â†“
  4. server/lease/lessor.go:(*lessor).Recover()
     â†“
  5. server/lease/lessor.go:(*lessor).runLoop()
  
  API é›†æˆ:
  ğŸ“ server/etcdserver/api/v3rpc/lease.go
  - LeaseGrant(): åˆ›å»ºç§Ÿçº¦
  - LeaseRevoke(): æ’¤é”€ç§Ÿçº¦
  - LeaseKeepAlive(): ä¿æŒæ´»è·ƒ
  - LeaseTimeToLive(): è·å–å‰©ä½™æ—¶é—´
  
  å­˜å‚¨æ¡¶:
  - leaseBucketName: ç§Ÿçº¦æ•°æ®
  - leaseCheckpointBucketName: æ£€æŸ¥ç‚¹æ•°æ®
end note

note as N2
  ç§Ÿçº¦è¿‡æœŸå¤„ç†æµç¨‹:
  
  1. server/lease/lessor.go:(*lessor).runLoop()
     â†“ å®šæœŸæ£€æŸ¥
  2. server/lease/lessor.go:(*lessor).expireExists()
     â†“ æŸ¥æ‰¾è¿‡æœŸç§Ÿçº¦
  3. server/lease/lessor.go:(*LeaseExpiredNotifier).Poll()
     â†“ è·å–è¿‡æœŸç§Ÿçº¦
  4. server/etcdserver/server.go:(*EtcdServer).deleteLeasedKeys()
     â†“ åˆ é™¤å…³è”é”®
  5. server/storage/mvcc/kvstore.go:(*store).DeleteRange()
     â†“ æ‰§è¡Œåˆ é™¤æ“ä½œ
  
  å…³é”®å¸¸é‡:
  - leaseRevokeRate: æ’¤é”€é€Ÿç‡é™åˆ¶
  - maxLeaseCheckpointBatchSize: æ‰¹å¤„ç†å¤§å°
end note

@enduml
