@startuml raft-consensus-flow-code
!theme plain
title Raft ä¸€è‡´æ€§ç®—æ³•æµç¨‹å›¾ - ä»£ç å®ç°ä½ç½®

participant "å®¢æˆ·ç«¯\nClient" as C
participant "é¢†å¯¼è€…\nLeader" as L
participant "è·Ÿéšè€…1\nFollower1" as F1
participant "è·Ÿéšè€…2\nFollower2" as F2

== æ­£å¸¸å†™å…¥æµç¨‹ Normal Write Flow ==

C -> L : å†™å…¥è¯·æ±‚\nPut Request
note right of C
ğŸ“ client/v3/kv.go:(*kv).Put()
ğŸ“ client/v3/client.go:(*Client).dial()
end note

activate L
note right of L
ğŸ“ server/etcdserver/api/v3rpc/key.go:(*kvServer).Put()
ğŸ“ server/etcdserver/server.go:(*EtcdServer).Put()
ğŸ“ server/etcdserver/server.go:(*EtcdServer).processInternalRaftRequestOnce()
end note

L -> L : æ·»åŠ åˆ°æœ¬åœ°æ—¥å¿—\nAppend to Local Log
note right of L
ğŸ“ raft/raft.go:(*raft).Step()
ğŸ“ raft/raft.go:(*raft).appendEntry()
ğŸ“ raft/log.go:(*raftLog).append()
ğŸ“ server/storage/wal/wal.go:(*WAL).Save()

æ—¥å¿—æ¡ç›®åŒ…å«:
- Term: å½“å‰ä»»æœŸ
- Index: æ—¥å¿—ç´¢å¼•  
- Data: è¯·æ±‚æ•°æ®
end note

L -> F1 : AppendEntries RPC\n(æ—¥å¿—å¤åˆ¶)
note right of L
ğŸ“ server/etcdserver/api/rafthttp/transport.go:(*Transport).Send()
ğŸ“ server/etcdserver/api/rafthttp/pipeline.go:(*pipeline).post()
ğŸ“ raft/raft.go:(*raft).sendAppend()
end note

L -> F2 : AppendEntries RPC\n(æ—¥å¿—å¤åˆ¶)

activate F1
note right of F1
ğŸ“ server/etcdserver/api/rafthttp/stream.go:(*streamReader).decodeLoop()
ğŸ“ server/etcdserver/raft.go:(*raftNode).Process()
ğŸ“ raft/raft.go:(*raft).Step()
end note

F1 -> F1 : æ£€æŸ¥æ—¥å¿—ä¸€è‡´æ€§\nCheck Log Consistency
note right of F1
ğŸ“ raft/raft.go:(*raft).handleAppendEntries()
ğŸ“ raft/log.go:(*raftLog).maybeAppend()
ğŸ“ raft/log.go:(*raftLog).findConflict()
end note

F1 -> F1 : æ·»åŠ åˆ°æœ¬åœ°æ—¥å¿—\nAppend to Local Log
note right of F1
ğŸ“ raft/log.go:(*raftLog).append()
ğŸ“ server/storage/wal/wal.go:(*WAL).Save()
end note

F1 -> L : æˆåŠŸå“åº”\nSuccess Response
note right of F1
ğŸ“ raft/raft.go:(*raft).send()
ğŸ“ server/etcdserver/api/rafthttp/transport.go:(*Transport).Send()
end note

activate F2
note right of F2
ğŸ“ server/etcdserver/api/rafthttp/stream.go:(*streamReader).decodeLoop()
ğŸ“ server/etcdserver/raft.go:(*raftNode).Process()
ğŸ“ raft/raft.go:(*raft).Step()
end note

F2 -> F2 : æ£€æŸ¥æ—¥å¿—ä¸€è‡´æ€§\nCheck Log Consistency  
note right of F2
ğŸ“ raft/raft.go:(*raft).handleAppendEntries()
ğŸ“ raft/log.go:(*raftLog).maybeAppend()
end note

F2 -> F2 : æ·»åŠ åˆ°æœ¬åœ°æ—¥å¿—\nAppend to Local Log
note right of F2
ğŸ“ raft/log.go:(*raftLog).append()
ğŸ“ server/storage/wal/wal.go:(*WAL).Save()
end note

F2 -> L : æˆåŠŸå“åº”\nSuccess Response
note right of F2
ğŸ“ raft/raft.go:(*raft).send()
ğŸ“ server/etcdserver/api/rafthttp/transport.go:(*Transport).Send()
end note

deactivate F1
deactivate F2

note over L : æ”¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ç¡®è®¤\nReceived Majority Acks
note right of L
ğŸ“ raft/raft.go:(*raft).maybeCommit()
ğŸ“ raft/raft.go:quorum()
end note

L -> L : æäº¤æ—¥å¿—æ¡ç›®\nCommit Log Entry
note right of L
ğŸ“ raft/raft.go:(*raft).commitTo()
ğŸ“ raft/log.go:(*raftLog).commitTo()
end note

L -> L : åº”ç”¨åˆ°çŠ¶æ€æœº\nApply to State Machine
note right of L
ğŸ“ server/etcdserver/server.go:(*EtcdServer).applyEntryNormal()
ğŸ“ server/etcdserver/apply/apply_v3.go:(*applierV3).Apply()
ğŸ“ server/storage/mvcc/kvstore.go:(*store).Put()
end note

L -> C : å†™å…¥æˆåŠŸå“åº”\nPut Response
note right of L
ğŸ“ server/etcdserver/api/v3rpc/key.go:(*kvServer).Put()
ğŸ“ api/etcdserverpb/rpc.proto:PutResponse
end note
deactivate L

L -> F1 : ä¸‹æ¬¡å¿ƒè·³é€šçŸ¥æäº¤\nNext Heartbeat with Commit Index
note right of L
ğŸ“ raft/raft.go:(*raft).sendHeartbeat()
ğŸ“ raft/raft.go:(*raft).bcastHeartbeat()
end note

L -> F2 : ä¸‹æ¬¡å¿ƒè·³é€šçŸ¥æäº¤\nNext Heartbeat with Commit Index

F1 -> F1 : åº”ç”¨å·²æäº¤æ¡ç›®\nApply Committed Entries
note right of F1
ğŸ“ server/etcdserver/server.go:(*EtcdServer).applyEntryNormal()
ğŸ“ server/etcdserver/apply/apply_v3.go:(*applierV3).Apply()
end note

F2 -> F2 : åº”ç”¨å·²æäº¤æ¡ç›®\nApply Committed Entries
note right of F2
ğŸ“ server/etcdserver/server.go:(*EtcdServer).applyEntryNormal()
ğŸ“ server/etcdserver/apply/apply_v3.go:(*applierV3).Apply()
end note

== é¢†å¯¼è€…é€‰ä¸¾æµç¨‹ Leader Election ==

note over F1 : é€‰ä¸¾è¶…æ—¶\nElection Timeout
note right of F1
ğŸ“ raft/raft.go:(*raft).tick()
ğŸ“ raft/raft.go:(*raft).tickElection()
ğŸ“ raft/raft.go:(*raft).hup()
end note

F1 -> F1 : æˆä¸ºå€™é€‰è€…\nBecome Candidate
note right of F1
ğŸ“ raft/raft.go:(*raft).becomeCandidate()
ğŸ“ raft/raft.go:(*raft).campaign()
end note

F1 -> F1 : å¢åŠ ä»»æœŸ\nIncrement Term
note right of F1
ğŸ“ raft/raft.go:(*raft).becomeCandidate()
raft.Term++
end note

F1 -> F1 : ä¸ºè‡ªå·±æŠ•ç¥¨\nVote for Self
note right of F1
ğŸ“ raft/raft.go:(*raft).becomeCandidate()
raft.Vote = raft.id
end note

F1 -> L : RequestVote RPC\nè¯·æ±‚æŠ•ç¥¨
note right of F1
ğŸ“ raft/raft.go:(*raft).campaign()
ğŸ“ server/etcdserver/api/rafthttp/transport.go:(*Transport).Send()
end note

F1 -> F2 : RequestVote RPC\nè¯·æ±‚æŠ•ç¥¨

L -> L : æ£€æŸ¥ä»»æœŸå’Œæ—¥å¿—\nCheck Term and Log
note right of L
ğŸ“ raft/raft.go:(*raft).Step()
ğŸ“ raft/raft.go:(*raft).handleRequestVote()
ğŸ“ raft/log.go:(*raftLog).isUpToDate()
end note

L -> F1 : æŠ•ç¥¨æˆäºˆ\nVote Granted
note right of L
ğŸ“ raft/raft.go:(*raft).send()
ğŸ“ api/etcdserverpb/raft_internal.proto:Message
end note

F2 -> F2 : æ£€æŸ¥ä»»æœŸå’Œæ—¥å¿—\nCheck Term and Log  
note right of F2
ğŸ“ raft/raft.go:(*raft).Step()
ğŸ“ raft/raft.go:(*raft).handleRequestVote()
end note

F2 -> F1 : æŠ•ç¥¨æˆäºˆ\nVote Granted
note right of F2
ğŸ“ raft/raft.go:(*raft).send()
end note

note over F1 : è·å¾—å¤§å¤šæ•°é€‰ç¥¨\nReceived Majority Votes
note right of F1
ğŸ“ raft/raft.go:(*raft).Step()
ğŸ“ raft/raft.go:quorum()
end note

F1 -> F1 : æˆä¸ºé¢†å¯¼è€…\nBecome Leader
note right of F1
ğŸ“ raft/raft.go:(*raft).becomeLeader()
ğŸ“ raft/raft.go:(*raft).bcastAppend()
end note

F1 -> L : å¿ƒè·³æ¶ˆæ¯\nHeartbeat (AppendEntries)
note right of F1
ğŸ“ raft/raft.go:(*raft).sendHeartbeat()
ğŸ“ raft/raft.go:(*raft).bcastHeartbeat()
end note

F1 -> F2 : å¿ƒè·³æ¶ˆæ¯\nHeartbeat (AppendEntries)

L -> L : å‘ç°æ›´é«˜ä»»æœŸ\nDiscover Higher Term
note right of L
ğŸ“ raft/raft.go:(*raft).Step()
ğŸ“ raft/raft.go:(*raft).becomeFollower()
end note

L -> L : æˆä¸ºè·Ÿéšè€…\nBecome Follower

== ç½‘ç»œåˆ†åŒºæ¢å¤ Network Partition Recovery ==

note over L, F2 : ç½‘ç»œåˆ†åŒº\nNetwork Partition
note right of L
ğŸ“ server/etcdserver/api/rafthttp/transport.go:(*Transport).Send()
ğŸ“ server/etcdserver/api/rafthttp/peer.go:(*peer).send()
ç½‘ç»œé”™è¯¯å¤„ç†
end note

C -> L : å†™å…¥è¯·æ±‚\nPut Request
L -> F1 : AppendEntries RPC
L -x F2 : ç½‘ç»œä¸å¯è¾¾\nNetwork Unreachable
note right of L
ğŸ“ server/etcdserver/api/rafthttp/pipeline.go:(*pipeline).post()
ç½‘ç»œè¶…æ—¶æˆ–è¿æ¥å¤±è´¥
end note

note over L : æ— æ³•è·å¾—å¤§å¤šæ•°ç¡®è®¤\nCannot Get Majority
note right of L
ğŸ“ raft/raft.go:(*raft).maybeCommit()
ğŸ“ server/etcdserver/server.go:(*EtcdServer).processInternalRaftRequestOnce()
context.DeadlineExceeded
end note

L -> C : è¯·æ±‚å¤±è´¥\nRequest Failed
note right of L
ğŸ“ server/etcdserver/api/v3rpc/key.go:(*kvServer).Put()
è¿”å›è¶…æ—¶é”™è¯¯
end note

note over L, F2 : ç½‘ç»œæ¢å¤\nNetwork Recovered
note right of L
ğŸ“ server/etcdserver/api/rafthttp/transport.go:(*Transport).AddPeer()
ğŸ“ server/etcdserver/api/rafthttp/peer.go:(*peer).startPeer()
é‡æ–°å»ºç«‹è¿æ¥
end note

L -> F2 : AppendEntries RPC\n(åŒ…å«ç¼ºå¤±æ—¥å¿—)
note right of L
ğŸ“ raft/raft.go:(*raft).sendAppend()
ğŸ“ raft/raft.go:(*raft).maybeSendAppend()
å‘é€ç¼ºå¤±çš„æ—¥å¿—æ¡ç›®
end note

F2 -> F2 : åŒæ­¥ç¼ºå¤±æ—¥å¿—\nSync Missing Logs
note right of F2
ğŸ“ raft/raft.go:(*raft).handleAppendEntries()
ğŸ“ raft/log.go:(*raftLog).maybeAppend()
åŒæ­¥æ—¥å¿—å¹¶åº”ç”¨å·²æäº¤æ¡ç›®
end note

F2 -> L : æˆåŠŸå“åº”\nSuccess Response
note right of F2
ğŸ“ raft/raft.go:(*raft).send()
ç¡®è®¤æ—¥å¿—åŒæ­¥å®Œæˆ
end note

note as N1
Raft ç®—æ³•æ ¸å¿ƒå®ç°ä½ç½®:

ğŸ“ raft/raft.go - Raft ç®—æ³•ä¸»å®ç°
- (*raft).Step(): å¤„ç†æ¶ˆæ¯
- (*raft).tick(): æ—¶é’Ÿé©±åŠ¨
- (*raft).campaign(): å‘èµ·é€‰ä¸¾
- (*raft).becomeLeader(): æˆä¸ºé¢†å¯¼è€…
- (*raft).becomeFollower(): æˆä¸ºè·Ÿéšè€…
- (*raft).becomeCandidate(): æˆä¸ºå€™é€‰è€…

ğŸ“ raft/log.go - Raft æ—¥å¿—å®ç°
- (*raftLog).append(): è¿½åŠ æ—¥å¿—
- (*raftLog).maybeAppend(): æ¡ä»¶è¿½åŠ 
- (*raftLog).commitTo(): æäº¤æ—¥å¿—
- (*raftLog).isUpToDate(): æ£€æŸ¥æ—¥å¿—æ–°æ—§

ğŸ“ raft/node.go - Raft èŠ‚ç‚¹æ¥å£
- (*node).Propose(): æè®®æ–°æ¡ç›®
- (*node).Step(): å¤„ç†æ¶ˆæ¯
- (*node).Ready(): è·å–å°±ç»ªçŠ¶æ€
end note

note as N2
ç½‘ç»œä¼ è¾“å®ç°ä½ç½®:

ğŸ“ server/etcdserver/api/rafthttp/transport.go
- (*Transport).Send(): å‘é€æ¶ˆæ¯
- (*Transport).AddPeer(): æ·»åŠ å¯¹ç­‰èŠ‚ç‚¹
- (*Transport).RemovePeer(): ç§»é™¤å¯¹ç­‰èŠ‚ç‚¹

ğŸ“ server/etcdserver/api/rafthttp/pipeline.go
- (*pipeline).post(): ç®¡é“å‘é€
- (*pipeline).handle(): å¤„ç†å“åº”

ğŸ“ server/etcdserver/api/rafthttp/stream.go
- (*streamWriter).run(): æµå†™å…¥
- (*streamReader).run(): æµè¯»å–

ğŸ“ server/etcdserver/api/rafthttp/peer.go
- (*peer).send(): å¯¹ç­‰èŠ‚ç‚¹å‘é€
- (*peer).startPeer(): å¯åŠ¨å¯¹ç­‰èŠ‚ç‚¹
end note

note as N3
çŠ¶æ€æœºåº”ç”¨å®ç°ä½ç½®:

ğŸ“ server/etcdserver/server.go
- (*EtcdServer).applyEntryNormal(): åº”ç”¨æ™®é€šæ¡ç›®
- (*EtcdServer).applyConfChange(): åº”ç”¨é…ç½®å˜æ›´
- (*EtcdServer).processInternalRaftRequestOnce(): å¤„ç†å†…éƒ¨è¯·æ±‚

ğŸ“ server/etcdserver/apply/apply_v3.go
- (*applierV3).Apply(): åº”ç”¨ v3 æ“ä½œ
- (*applierV3).Put(): åº”ç”¨ Put æ“ä½œ
- (*applierV3).Range(): åº”ç”¨ Range æ“ä½œ
- (*applierV3).Txn(): åº”ç”¨äº‹åŠ¡æ“ä½œ

ğŸ“ server/storage/mvcc/kvstore.go
- (*store).Put(): MVCC å­˜å‚¨
- (*store).Range(): MVCC æŸ¥è¯¢
end note

@enduml
