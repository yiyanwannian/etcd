@startuml tools-ecosystem-code
!theme plain
title etcd å·¥å…·ç”Ÿæ€ç³»ç»Ÿ - ä»£ç å®ç°ä½ç½®

package "å‘½ä»¤è¡Œå·¥å…· Command Line Tools" {
  class etcdctl {
    +endpoints: []string
    +dialTimeout: time.Duration
    +commandTimeout: time.Duration
    +user: string
    +password: string
    +cacert: string
    +cert: string
    +key: string
    +Put()
    +Get()
    +Del()
    +Watch()
    +Lease()
    +Auth()
    +Member()
    +Snapshot()
    +Txn()
    --
    ğŸ“ etcdctl/main.go:main()
    ğŸ“ etcdctl/ctlv3/command/global.go:GlobalFlags
    ğŸ“ etcdctl/ctlv3/command/put_command.go:NewPutCommand()
    ğŸ“ etcdctl/ctlv3/command/get_command.go:NewGetCommand()
    ğŸ“ etcdctl/ctlv3/command/del_command.go:NewDelCommand()
    ğŸ“ etcdctl/ctlv3/command/watch_command.go:NewWatchCommand()
    ğŸ“ etcdctl/ctlv3/command/lease_command.go:NewLeaseCommand()
    ğŸ“ etcdctl/ctlv3/command/auth_command.go:NewAuthCommand()
    ğŸ“ etcdctl/ctlv3/command/member_command.go:NewMemberCommand()
    ğŸ“ etcdctl/ctlv3/command/snapshot_command.go:NewSnapshotCommand()
    ğŸ“ etcdctl/ctlv3/command/txn_command.go:NewTxnCommand()
  }
  
  class etcdutl {
    +dataDir: string
    +walDir: string
    +snapshotFile: string
    +SnapshotSave()
    +SnapshotRestore()
    +SnapshotStatus()
    +Migrate()
    +Defrag()
    +Check()
    +Compact()
    --
    ğŸ“ etcdutl/main.go:main()
    ğŸ“ etcdutl/etcdutl/snapshot_command.go:NewSnapshotCommand()
    ğŸ“ etcdutl/etcdutl/migrate_command.go:NewMigrateCommand()
    ğŸ“ etcdutl/etcdutl/defrag_command.go:NewDefragCommand()
    ğŸ“ etcdutl/etcdutl/backup_command.go:NewBackupCommand()
  }
  
  class etcd {
    +name: string
    +dataDir: string
    +walDir: string
    +listenClientUrls: []url.URL
    +listenPeerUrls: []url.URL
    +initialCluster: string
    +initialClusterState: string
    +Start()
    +Stop()
    +Serve()
    --
    ğŸ“ server/etcdmain/main.go:main()
    ğŸ“ server/etcdmain/etcd.go:startEtcdOrProxyV2()
    ğŸ“ server/etcdmain/config.go:newConfig()
    ğŸ“ server/embed/etcd.go:StartEtcd()
  }
}

package "æ€§èƒ½æµ‹è¯•å·¥å…· Benchmark Tools" {
  class benchmark {
    +endpoints: []string
    +clients: int
    +conns: int
    +keySize: int
    +valSize: int
    +total: int
    +rate: int
    +Put()
    +Range()
    +Mixed()
    +Watch()
    +Lease()
    +STM()
    --
    ğŸ“ tools/benchmark/main.go:main()
    ğŸ“ tools/benchmark/cmd/put.go:NewPutCommand()
    ğŸ“ tools/benchmark/cmd/range.go:NewRangeCommand()
    ğŸ“ tools/benchmark/cmd/mixed.go:NewMixedCommand()
    ğŸ“ tools/benchmark/cmd/watch.go:NewWatchCommand()
    ğŸ“ tools/benchmark/cmd/lease.go:NewLeaseCommand()
    ğŸ“ tools/benchmark/cmd/stm.go:NewSTMCommand()
  }
  
  class BenchmarkResult {
    +Total: int
    +Seconds: float64
    +RPS: float64
    +AvgLatency: time.Duration
    +P50Latency: time.Duration
    +P95Latency: time.Duration
    +P99Latency: time.Duration
    +P999Latency: time.Duration
    --
    ğŸ“ tools/benchmark/cmd/util.go:report
    ğŸ“ tools/benchmark/cmd/util.go:(*report).Results()
    ğŸ“ tools/benchmark/cmd/util.go:(*report).Stats()
  }
}

package "æ•°æ®å¯¼å‡ºå·¥å…· Data Export Tools" {
  class etcd_dump_db {
    +dbPath: string
    +ListBucket()
    +IterateBucket()
    +DumpKeys()
    +DumpValues()
    --
    ğŸ“ tools/etcd-dump-db/main.go:main()
    ğŸ“ tools/etcd-dump-db/main.go:listBucket()
    ğŸ“ tools/etcd-dump-db/main.go:iterateBucket()
  }
  
  class etcd_dump_logs {
    +walDir: string
    +DumpWAL()
    +DumpEntries()
    +AnalyzeLog()
    --
    ğŸ“ tools/etcd-dump-logs/main.go:main()
    ğŸ“ tools/etcd-dump-logs/main.go:dumpWAL()
    ğŸ“ tools/etcd-dump-logs/main.go:dumpSnapshot()
  }
  
  class etcd_dump_metrics {
    +endpoints: []string
    +outputFile: string
    +DumpMetrics()
    +ExportPrometheus()
    --
    ğŸ“ tools/etcd-dump-metrics/main.go:main()
    ğŸ“ tools/etcd-dump-metrics/main.go:dumpMetrics()
  }
}

package "æœ¬åœ°æµ‹è¯•å·¥å…· Local Testing Tools" {
  class local_tester {
    +agentEndpoints: []string
    +stressKeyCount: int
    +stressKeySize: int
    +failureCases: []string
    +RunTest()
    +InjectFailure()
    +CheckConsistency()
    +GenerateReport()
    --
    ğŸ“ tools/local-tester/main.go:main()
    ğŸ“ tools/local-tester/bridge/bridge.go:Bridge
    ğŸ“ tools/local-tester/bridge/bridge.go:(*Bridge).Run()
  }
  
  class Agent {
    +endpoint: string
    +etcdPath: string
    +dataDir: string
    +Start()
    +Stop()
    +Kill()
    +Restart()
    +Status()
    --
    ğŸ“ tools/local-tester/bridge/bridge.go:Agent
    ğŸ“ tools/local-tester/bridge/bridge.go:(*Agent).Start()
    ğŸ“ tools/local-tester/bridge/bridge.go:(*Agent).Stop()
    ğŸ“ tools/local-tester/bridge/bridge.go:(*Agent).Restart()
  }
  
  class FailureCase {
    +name: string
    +description: string
    +Execute()
    +Recover()
    --
    ğŸ“ tools/local-tester/bridge/bridge.go:FailureCase
    ğŸ“ tools/local-tester/bridge/bridge.go:injectFailure()
  }
}

package "å¼€å‘å·¥å…· Development Tools" {
  class proto_annotations {
    +protoFiles: []string
    +outputDir: string
    +Generate()
    +Validate()
    --
    ğŸ“ tools/proto-annotations/main.go:main()
    ğŸ“ api/etcdserverpb/rpc.proto
    ğŸ“ api/mvccpb/kv.proto
    ğŸ“ api/authpb/auth.proto
  }
  
  class mod_tools {
    +goMod: string
    +Update()
    +Tidy()
    +Vendor()
    +Check()
    --
    ğŸ“ tools/mod/main.go:main()
    ğŸ“ go.mod
    ğŸ“ go.sum
    ğŸ“ scripts/build.sh
  }
  
  class testgrid_analysis {
    +testResults: []TestResult
    +Analyze()
    +GenerateReport()
    +FindFlaky()
    --
    ğŸ“ tools/testgrid-analysis/main.go:main()
    ğŸ“ tools/testgrid-analysis/cmd/analyze.go
  }
}

package "ç›‘æ§å·¥å…· Monitoring Tools" {
  class prometheus_exporter {
    +metricsPath: string
    +listenAddress: string
    +etcdEndpoints: []string
    +CollectMetrics()
    +ExportMetrics()
    --
    ğŸ“ server/etcdserver/api/v3rpc/metrics.go
    ğŸ“ server/storage/mvcc/metrics.go
    ğŸ“ server/lease/metrics.go
    ğŸ“ raft/node.go:Status()
    ğŸ“ github.com/prometheus/client_golang
  }
  
  class grafana_dashboard {
    +dashboardConfig: string
    +panels: []Panel
    +CreateDashboard()
    +UpdatePanels()
    --
    ğŸ“ Documentation/op-guide/grafana.json
    ğŸ“ contrib/grafana-dashboard.json
  }
  
  class alertmanager_rules {
    +rulesFile: string
    +alertRules: []AlertRule
    +LoadRules()
    +ValidateRules()
    --
    ğŸ“ Documentation/op-guide/etcd3_alert.rules.yml
  }
}

package "éƒ¨ç½²å·¥å…· Deployment Tools" {
  class etcd_operator {
    +namespace: string
    +clusterName: string
    +size: int
    +version: string
    +CreateCluster()
    +UpdateCluster()
    +DeleteCluster()
    +BackupCluster()
    +RestoreCluster()
    --
    ğŸ“ contrib/raftexample/
    ğŸ“ hack/scripts-dev/docker-dns/
    ğŸ“ hack/scripts-dev/docker-local/
  }
  
  class helm_chart {
    +chartName: string
    +values: map[string]interface{}
    +Install()
    +Upgrade()
    +Uninstall()
    +Template()
    --
    ğŸ“ contrib/helm/etcd/
    ğŸ“ contrib/helm/etcd/Chart.yaml
    ğŸ“ contrib/helm/etcd/values.yaml
  }
  
  class ansible_playbook {
    +inventory: string
    +playbook: string
    +variables: map[string]string
    +Deploy()
    +Configure()
    +Maintain()
    --
    ğŸ“ hack/scripts-dev/
    ğŸ“ scripts/
  }
}

' å·¥å…·å…³ç³»è¿æ¥
etcdctl --> etcd : ç®¡ç†å’Œæ“ä½œ\nğŸ“ etcdctl/ â†’ server/
etcdutl --> etcd : ç»´æŠ¤å’Œä¿®å¤\nğŸ“ etcdutl/ â†’ server/
benchmark --> etcd : æ€§èƒ½æµ‹è¯•\nğŸ“ tools/benchmark/ â†’ server/

etcd_dump_db --> etcd : æ•°æ®å¯¼å‡º\nğŸ“ tools/etcd-dump-db/
etcd_dump_logs --> etcd : æ—¥å¿—åˆ†æ\nğŸ“ tools/etcd-dump-logs/
etcd_dump_metrics --> etcd : æŒ‡æ ‡å¯¼å‡º\nğŸ“ tools/etcd-dump-metrics/

local_tester --> Agent : ç®¡ç†æµ‹è¯•ä»£ç†\nğŸ“ tools/local-tester/bridge/
Agent --> etcd : æ§åˆ¶ etcd å®ä¾‹\nğŸ“ tools/local-tester/bridge/
local_tester --> FailureCase : æ‰§è¡Œæ•…éšœæ¡ˆä¾‹\nğŸ“ tools/local-tester/bridge/

prometheus_exporter --> etcd : æ”¶é›†æŒ‡æ ‡\nğŸ“ server/etcdserver/api/v3rpc/metrics.go
grafana_dashboard --> prometheus_exporter : å¯è§†åŒ–æŒ‡æ ‡\nğŸ“ Documentation/op-guide/
alertmanager_rules --> prometheus_exporter : å‘Šè­¦è§„åˆ™\nğŸ“ Documentation/op-guide/

etcd_operator --> etcd : Kubernetes éƒ¨ç½²\nğŸ“ contrib/
helm_chart --> etcd : Helm éƒ¨ç½²\nğŸ“ contrib/helm/
ansible_playbook --> etcd : Ansible éƒ¨ç½²\nğŸ“ hack/scripts-dev/

benchmark --> BenchmarkResult : ç”Ÿæˆç»“æœ\nğŸ“ tools/benchmark/cmd/util.go

note right of etcdctl
  ä¸»è¦å®¢æˆ·ç«¯å·¥å…·å®ç°:
  ğŸ“ etcdctl/main.go
  ğŸ“ etcdctl/ctlv3/command/
  
  å‘½ä»¤å®ç°:
  - global.go: å…¨å±€é…ç½®
  - put_command.go: Put å‘½ä»¤
  - get_command.go: Get å‘½ä»¤
  - watch_command.go: Watch å‘½ä»¤
  - lease_command.go: Lease å‘½ä»¤
  - auth_command.go: Auth å‘½ä»¤
  - member_command.go: Member å‘½ä»¤
  - snapshot_command.go: Snapshot å‘½ä»¤
  
  ä¾èµ–:
  ğŸ“ client/v3/: å®¢æˆ·ç«¯ SDK
end note

note right of benchmark
  æ€§èƒ½æµ‹è¯•å·¥å…·å®ç°:
  ğŸ“ tools/benchmark/
  
  æµ‹è¯•å‘½ä»¤:
  - cmd/put.go: å†™å…¥æ€§èƒ½æµ‹è¯•
  - cmd/range.go: è¯»å–æ€§èƒ½æµ‹è¯•
  - cmd/mixed.go: æ··åˆè¯»å†™æµ‹è¯•
  - cmd/watch.go: ç›‘å¬æ€§èƒ½æµ‹è¯•
  - cmd/lease.go: ç§Ÿçº¦æ€§èƒ½æµ‹è¯•
  - cmd/stm.go: STM äº‹åŠ¡æµ‹è¯•
  
  å·¥å…·å‡½æ•°:
  - cmd/util.go: é€šç”¨å·¥å…·å‡½æ•°
  - cmd/util.go: æ€§èƒ½ç»Ÿè®¡å’ŒæŠ¥å‘Š
end note

note right of etcdutl
  æ•°æ®åº“å·¥å…·å®ç°:
  ğŸ“ etcdutl/
  
  ä¸»è¦åŠŸèƒ½:
  - snapshot_command.go: å¿«ç…§æ“ä½œ
  - migrate_command.go: æ•°æ®è¿ç§»
  - defrag_command.go: ç¢ç‰‡æ•´ç†
  - backup_command.go: å¤‡ä»½æ“ä½œ
  
  ä¾èµ–:
  ğŸ“ server/storage/: å­˜å‚¨å¼•æ“
  ğŸ“ server/storage/snap/: å¿«ç…§ç®¡ç†
  ğŸ“ server/storage/wal/: WAL ç®¡ç†
end note

note right of local_tester
  æœ¬åœ°æµ‹è¯•æ¡†æ¶å®ç°:
  ğŸ“ tools/local-tester/
  
  æ ¸å¿ƒç»„ä»¶:
  - bridge/bridge.go: æµ‹è¯•æ¡¥æ¥å™¨
  - bridge/bridge.go: Agent ç®¡ç†
  - bridge/bridge.go: æ•…éšœæ³¨å…¥
  
  æµ‹è¯•åŠŸèƒ½:
  - æ•…éšœæ³¨å…¥æµ‹è¯•
  - ä¸€è‡´æ€§éªŒè¯
  - è‡ªåŠ¨åŒ–æµ‹è¯•
  - å›å½’æµ‹è¯•
  
  æ•…éšœç±»å‹:
  - èŠ‚ç‚¹å´©æºƒ
  - ç½‘ç»œåˆ†åŒº
  - ç£ç›˜æ•…éšœ
  - æ€§èƒ½å‹åŠ›
end note

note as N1
  å·¥å…·æ„å»ºå’Œä½¿ç”¨:
  
  æ„å»ºè„šæœ¬:
  ğŸ“ scripts/build.sh
  ğŸ“ Makefile
  
  æ„å»ºå‘½ä»¤:
  - make build: æ„å»ºæ‰€æœ‰ç»„ä»¶
  - make tools: æ„å»ºå·¥å…·
  - make test-tools: æµ‹è¯•å·¥å…·
  
  å®‰è£…è·¯å¾„:
  - bin/etcd: æœåŠ¡å™¨äºŒè¿›åˆ¶
  - bin/etcdctl: å®¢æˆ·ç«¯å·¥å…·
  - bin/etcdutl: æ•°æ®åº“å·¥å…·
  
  é…ç½®æ–‡ä»¶:
  ğŸ“ go.mod: Go æ¨¡å—é…ç½®
  ğŸ“ .goreleaser.yml: å‘å¸ƒé…ç½®
end note

note as N2
  ç›‘æ§é›†æˆ:
  
  Prometheus æŒ‡æ ‡:
  ğŸ“ server/etcdserver/api/v3rpc/metrics.go
  ğŸ“ server/storage/mvcc/metrics.go
  ğŸ“ server/lease/metrics.go
  
  Grafana ä»ªè¡¨æ¿:
  ğŸ“ Documentation/op-guide/grafana.json
  ğŸ“ contrib/grafana-dashboard.json
  
  å‘Šè­¦è§„åˆ™:
  ğŸ“ Documentation/op-guide/etcd3_alert.rules.yml
  
  æŒ‡æ ‡ç«¯ç‚¹:
  - /metrics: Prometheus æ ¼å¼æŒ‡æ ‡
  - /health: å¥åº·æ£€æŸ¥ç«¯ç‚¹
  - /debug/pprof/: æ€§èƒ½åˆ†æç«¯ç‚¹
end note

@enduml
