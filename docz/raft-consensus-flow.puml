@startuml raft-consensus-flow
!theme plain
title Raft 一致性算法流程图

participant "客户端\nClient" as C
participant "领导者\nLeader" as L
participant "跟随者1\nFollower1" as F1
participant "跟随者2\nFollower2" as F2

== 正常写入流程 Normal Write Flow ==

C -> L : 写入请求\nPut Request
activate L

L -> L : 添加到本地日志\nAppend to Local Log
note right : 日志条目包含:\n- Term: 当前任期\n- Index: 日志索引\n- Data: 请求数据

L -> F1 : AppendEntries RPC\n(日志复制)
L -> F2 : AppendEntries RPC\n(日志复制)

activate F1
activate F2

F1 -> F1 : 检查日志一致性\nCheck Log Consistency
F1 -> F1 : 添加到本地日志\nAppend to Local Log
F1 -> L : 成功响应\nSuccess Response

F2 -> F2 : 检查日志一致性\nCheck Log Consistency  
F2 -> F2 : 添加到本地日志\nAppend to Local Log
F2 -> L : 成功响应\nSuccess Response

deactivate F1
deactivate F2

note over L : 收到大多数节点确认\nReceived Majority Acks

L -> L : 提交日志条目\nCommit Log Entry
L -> L : 应用到状态机\nApply to State Machine

L -> C : 写入成功响应\nPut Response
deactivate L

L -> F1 : 下次心跳通知提交\nNext Heartbeat with Commit Index
L -> F2 : 下次心跳通知提交\nNext Heartbeat with Commit Index

F1 -> F1 : 应用已提交条目\nApply Committed Entries
F2 -> F2 : 应用已提交条目\nApply Committed Entries

== 领导者选举流程 Leader Election ==

note over F1 : 选举超时\nElection Timeout

F1 -> F1 : 成为候选者\nBecome Candidate
F1 -> F1 : 增加任期\nIncrement Term
F1 -> F1 : 为自己投票\nVote for Self

F1 -> L : RequestVote RPC\n请求投票
F1 -> F2 : RequestVote RPC\n请求投票

L -> L : 检查任期和日志\nCheck Term and Log
L -> F1 : 投票授予\nVote Granted

F2 -> F2 : 检查任期和日志\nCheck Term and Log  
F2 -> F1 : 投票授予\nVote Granted

note over F1 : 获得大多数选票\nReceived Majority Votes

F1 -> F1 : 成为领导者\nBecome Leader

F1 -> L : 心跳消息\nHeartbeat (AppendEntries)
F1 -> F2 : 心跳消息\nHeartbeat (AppendEntries)

L -> L : 发现更高任期\nDiscover Higher Term
L -> L : 成为跟随者\nBecome Follower

== 网络分区恢复 Network Partition Recovery ==

note over L, F2 : 网络分区\nNetwork Partition

C -> L : 写入请求\nPut Request
L -> F1 : AppendEntries RPC
L -x F2 : 网络不可达\nNetwork Unreachable

note over L : 无法获得大多数确认\nCannot Get Majority

L -> C : 请求失败\nRequest Failed

note over L, F2 : 网络恢复\nNetwork Recovered

L -> F2 : AppendEntries RPC\n(包含缺失日志)
F2 -> F2 : 同步缺失日志\nSync Missing Logs
F2 -> L : 成功响应\nSuccess Response

@enduml
