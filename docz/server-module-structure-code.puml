@startuml server-module-structure-code
!theme plain
title etcd Server æ¨¡å—ç»“æ„å›¾ - ä»£ç å®ç°ä½ç½®

package "etcdmain ä¸»ç¨‹åº" {
  class Main {
    +main()
    +parseConfig()
    +startEtcd()
    --
    ğŸ“ server/etcdmain/main.go:main()
    ğŸ“ server/etcdmain/config.go:newConfig()
    ğŸ“ server/etcdmain/etcd.go:startEtcdOrProxyV2()
  }
}

package "embed åµŒå…¥å¼æœåŠ¡å™¨" {
  class Etcd {
    +Peers: []*peerListener
    +Clients: []net.Listener
    +Server: *etcdserver.EtcdServer
    +cfg: Config
    +Start()
    +Close()
    --
    ğŸ“ server/embed/etcd.go:Etcd
    ğŸ“ server/embed/etcd.go:StartEtcd()
    ğŸ“ server/embed/etcd.go:(*Etcd).Close()
  }
  
  class Config {
    +Name: string
    +Dir: string
    +WalDir: string
    +ListenClientUrls: []url.URL
    +ListenPeerUrls: []url.URL
    +InitialCluster: string
    --
    ğŸ“ server/embed/config.go:Config
    ğŸ“ server/embed/config.go:NewConfig()
    ğŸ“ server/embed/config.go:(*Config).Validate()
  }
}

package "etcdserver æ ¸å¿ƒæœåŠ¡å™¨" {
  class EtcdServer {
    +r: raftNode
    +kv: mvcc.ConsistentWatchableKV
    +lessor: lease.Lessor
    +be: backend.Backend
    +cluster: *membership.RaftCluster
    +authStore: auth.AuthStore
    +Start()
    +Stop()
    +Process()
    --
    ğŸ“ server/etcdserver/server.go:EtcdServer
    ğŸ“ server/etcdserver/server.go:NewServer()
    ğŸ“ server/etcdserver/server.go:(*EtcdServer).Start()
    ğŸ“ server/etcdserver/server.go:(*EtcdServer).Stop()
    ğŸ“ server/etcdserver/server.go:(*EtcdServer).run()
  }
  
  class raftNode {
    +node: raft.Node
    +raftStorage: *raft.MemoryStorage
    +transport: rafthttp.Transporter
    +storage: Storage
    +start()
    +stop()
    +propose()
    --
    ğŸ“ server/etcdserver/raft.go:raftNode
    ğŸ“ server/etcdserver/raft.go:newRaftNode()
    ğŸ“ server/etcdserver/raft.go:(*raftNode).start()
    ğŸ“ server/etcdserver/raft.go:(*raftNode).stop()
    ğŸ“ server/etcdserver/raft.go:(*raftNode).propose()
  }
  
  class applyV3 {
    +s: *EtcdServer
    +Apply()
    +Put()
    +Range()
    +DeleteRange()
    +Txn()
    --
    ğŸ“ server/etcdserver/apply/apply_v3.go:applierV3
    ğŸ“ server/etcdserver/apply/apply_v3.go:(*applierV3).Apply()
    ğŸ“ server/etcdserver/apply/apply_v3.go:(*applierV3).Put()
    ğŸ“ server/etcdserver/apply/apply_v3.go:(*applierV3).Range()
    ğŸ“ server/etcdserver/apply/apply_v3.go:(*applierV3).Txn()
  }
}

package "API å¤„ç†å±‚" {
  class v3rpc {
    +KVServer
    +WatchServer
    +LeaseServer
    +AuthServer
    +ClusterServer
    +MaintenanceServer
    --
    ğŸ“ server/etcdserver/api/v3rpc/grpc.go:Server()
    ğŸ“ server/etcdserver/api/v3rpc/key.go:kvServer
    ğŸ“ server/etcdserver/api/v3rpc/watch.go:watchServer
    ğŸ“ server/etcdserver/api/v3rpc/lease.go:LeaseServer
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:AuthServer
    ğŸ“ server/etcdserver/api/v3rpc/cluster.go:ClusterServer
    ğŸ“ server/etcdserver/api/v3rpc/maintenance.go:MaintenanceServer
  }
  
  class quotaKVServer {
    +KVServer
    +checkQuota()
    --
    ğŸ“ server/etcdserver/api/v3rpc/quota.go:quotaKVServer
    ğŸ“ server/etcdserver/api/v3rpc/quota.go:(*quotaKVServer).Put()
    ğŸ“ server/etcdserver/api/v3rpc/quota.go:(*quotaKVServer).Txn()
  }
  
  class authKVServer {
    +KVServer
    +checkAuth()
    --
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:authKVServer
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*authKVServer).Range()
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*authKVServer).Put()
    ğŸ“ server/etcdserver/api/v3rpc/auth.go:(*authKVServer).DeleteRange()
  }
}

package "ç½‘ç»œä¼ è¾“å±‚" {
  class rafthttp.Transport {
    +ID: types.ID
    +ClusterID: types.ID
    +Raft: Raft
    +peers: map[types.ID]Peer
    +Send()
    +AddPeer()
    +RemovePeer()
    --
    ğŸ“ server/etcdserver/api/rafthttp/transport.go:Transport
    ğŸ“ server/etcdserver/api/rafthttp/transport.go:(*Transport).Start()
    ğŸ“ server/etcdserver/api/rafthttp/transport.go:(*Transport).Send()
    ğŸ“ server/etcdserver/api/rafthttp/transport.go:(*Transport).AddPeer()
    ğŸ“ server/etcdserver/api/rafthttp/transport.go:(*Transport).RemovePeer()
  }
  
  class pipeline {
    +peerID: types.ID
    +tr: *Transport
    +msgc: chan raftpb.Message
    +handle()
    +post()
    --
    ğŸ“ server/etcdserver/api/rafthttp/pipeline.go:pipeline
    ğŸ“ server/etcdserver/api/rafthttp/pipeline.go:(*pipeline).start()
    ğŸ“ server/etcdserver/api/rafthttp/pipeline.go:(*pipeline).handle()
    ğŸ“ server/etcdserver/api/rafthttp/pipeline.go:(*pipeline).post()
  }
}

' å…³ç³»è¿æ¥
Main --> Etcd : åˆ›å»ºå’Œå¯åŠ¨\nğŸ“ etcdmain/etcd.go
Etcd --> EtcdServer : åŒ…å«\nğŸ“ embed/etcd.go
Etcd --> Config : ä½¿ç”¨é…ç½®\nğŸ“ embed/config.go

EtcdServer --> raftNode : åŒ…å« Raft èŠ‚ç‚¹\nğŸ“ server/etcdserver/raft.go
EtcdServer --> applyV3 : åº”ç”¨çŠ¶æ€æœº\nğŸ“ server/etcdserver/apply/
raftNode --> rafthttp.Transport : ç½‘ç»œä¼ è¾“\nğŸ“ api/rafthttp/

v3rpc --> quotaKVServer : è£…é¥°å™¨æ¨¡å¼\nğŸ“ v3rpc/quota.go
quotaKVServer --> authKVServer : è£…é¥°å™¨æ¨¡å¼\nğŸ“ v3rpc/auth.go
authKVServer --> EtcdServer : æœ€ç»ˆå¤„ç†\nğŸ“ etcdserver/server.go

rafthttp.Transport --> pipeline : ç®¡é“ä¼ è¾“\nğŸ“ rafthttp/pipeline.go

note right of EtcdServer
  æ ¸å¿ƒæœåŠ¡å™¨å®ç°ä½ç½®:
  ğŸ“ server/etcdserver/server.go
  
  ä¸»è¦æ–¹æ³•:
  - NewServer(): åˆ›å»ºæœåŠ¡å™¨å®ä¾‹
  - Start(): å¯åŠ¨æœåŠ¡å™¨
  - run(): ä¸»è¿è¡Œå¾ªç¯
  - Process(): å¤„ç† Raft æ¶ˆæ¯
  - applyEntryNormal(): åº”ç”¨æ—¥å¿—æ¡ç›®
  
  å…³é”®å­—æ®µ:
  - r: Raft èŠ‚ç‚¹
  - kv: MVCC å­˜å‚¨
  - lessor: ç§Ÿçº¦ç®¡ç†å™¨
  - authStore: è®¤è¯å­˜å‚¨
end note

note right of raftNode
  Raft èŠ‚ç‚¹å®ç°ä½ç½®:
  ğŸ“ server/etcdserver/raft.go
  
  ä¸»è¦æ–¹æ³•:
  - newRaftNode(): åˆ›å»º Raft èŠ‚ç‚¹
  - start(): å¯åŠ¨ Raft å¤„ç†
  - propose(): æè®®æ–°æ¡ç›®
  - publishEntries(): å‘å¸ƒå·²æäº¤æ¡ç›®
  
  é›†æˆç»„ä»¶:
  - raft.Node: Raft ç®—æ³•æ ¸å¿ƒ
  - raftStorage: å†…å­˜å­˜å‚¨
  - transport: ç½‘ç»œä¼ è¾“
  - wal: é¢„å†™æ—¥å¿—
end note

note right of applyV3
  çŠ¶æ€æœºåº”ç”¨å®ç°ä½ç½®:
  ğŸ“ server/etcdserver/apply/apply_v3.go
  
  ä¸»è¦æ–¹æ³•:
  - Apply(): åº”ç”¨ Raft æ¡ç›®
  - Put(): å¤„ç† Put æ“ä½œ
  - Range(): å¤„ç† Range æ“ä½œ
  - DeleteRange(): å¤„ç†åˆ é™¤æ“ä½œ
  - Txn(): å¤„ç†äº‹åŠ¡æ“ä½œ
  
  åŠŸèƒ½:
  - è§£æ Raft æ—¥å¿—æ¡ç›®
  - æ‰§è¡Œ MVCC æ“ä½œ
  - ç”Ÿæˆå“åº”ç»“æœ
  - è§¦å‘ Watch äº‹ä»¶
end note

note right of v3rpc
  gRPC æœåŠ¡å®ç°ä½ç½®:
  ğŸ“ server/etcdserver/api/v3rpc/
  
  æœåŠ¡å™¨ç»„ä»¶:
  - grpc.go: æœåŠ¡å™¨åˆ›å»ºå’Œé…ç½®
  - key.go: KV æœåŠ¡å®ç°
  - watch.go: Watch æœåŠ¡å®ç°
  - lease.go: Lease æœåŠ¡å®ç°
  - auth.go: Auth æœåŠ¡å®ç°
  - maintenance.go: ç»´æŠ¤æœåŠ¡å®ç°
  
  è£…é¥°å™¨æ¨¡å¼:
  - quotaKVServer: é…é¢æ£€æŸ¥
  - authKVServer: æƒé™éªŒè¯
  - é“¾å¼è£…é¥°æä¾›å¤šå±‚ä¿æŠ¤
end note

note right of rafthttp.Transport
  ç½‘ç»œä¼ è¾“å®ç°ä½ç½®:
  ğŸ“ server/etcdserver/api/rafthttp/
  
  æ ¸å¿ƒæ–‡ä»¶:
  - transport.go: ä¼ è¾“å±‚ä¸»å®ç°
  - peer.go: å¯¹ç­‰èŠ‚ç‚¹ç®¡ç†
  - pipeline.go: æµæ°´çº¿ä¼ è¾“
  - stream.go: æµå¼ä¼ è¾“
  - snapshot_sender.go: å¿«ç…§å‘é€
  
  ä¼ è¾“ç­–ç•¥:
  - Pipeline: æ‰¹é‡æ¶ˆæ¯ä¼ è¾“
  - Stream: é¢‘ç¹å°æ¶ˆæ¯ä¼ è¾“
  - Snapshot: å¤§å‹å¿«ç…§ä¼ è¾“
end note

note as N1
  å¯åŠ¨æµç¨‹ä»£ç è·¯å¾„:
  
  1. server/etcdmain/main.go:main()
     â†“
  2. server/etcdmain/etcd.go:startEtcdOrProxyV2()
     â†“
  3. server/embed/etcd.go:StartEtcd()
     â†“
  4. server/etcdserver/server.go:NewServer()
     â†“
  5. server/etcdserver/server.go:(*EtcdServer).Start()
     â†“
  6. server/etcdserver/raft.go:(*raftNode).start()
     â†“
  7. server/etcdserver/api/v3rpc/grpc.go:Server()
  
  å…³é”®é…ç½®æ–‡ä»¶:
  - server/embed/config.go: åµŒå…¥å¼é…ç½®
  - server/etcdserver/config.go: æœåŠ¡å™¨é…ç½®
end note

@enduml
